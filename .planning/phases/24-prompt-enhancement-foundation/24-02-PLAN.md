---
phase: 24
plan: 02
name: Mode Selector System
type: foundation
wave: 1
depends_on: ["24-01"]
files_modified:
  - lib/prompt-enhancer/mode-selector.js
  - lib/prompt-enhancer/index.js
autonomous: true
must_haves:
  truths:
    - "Mode is automatically selected based on risk score"
    - "COMPREHENSIVE mode is used for complex prompts"
    - "NONE mode skips enhancement entirely"
    - "User can override mode with --mode flag"
  artifacts:
    - path: lib/prompt-enhancer/mode-selector.js
      min_lines: 80
      contains: ["selectMode", "COMPREHENSIVE", "STANDARD", "LIGHTWEIGHT", "NONE", "THRESHOLDS"]
  key_links:
    - from: risk-engine.js
      to: mode-selector.js
      via: "risk score"
      pattern: "selectMode(riskScore)"
---

# Phase 24-02: Mode Selector System

<objective>
Create intelligent mode selection system that chooses enhancement intensity based on risk score and prompt characteristics.

**Output:** `lib/prompt-enhancer/mode-selector.js` with threshold-based mode selection.
</objective>

<execution_context>
@references/mcp-tool-reference.md
@references/ui-brand.md
</execution_context>

<context>
Phase: 24 (Prompt Enhancement Foundation)
Depends on: 24-01 (Risk Assessment Engine)

**Mode Hierarchy:**
- COMPREHENSIVE: Full cognitive enhancement (score â‰¥60)
- STANDARD: Normal enhancement (score 30-59)
- LIGHTWEIGHT: Quick cleanup (score 10-29)
- NONE: Skip enhancement (score <10)

@.planning/STATE.md
</context>

<tasks>

## Task 1: Define Mode Constants and Thresholds

**Files:** lib/prompt-enhancer/mode-selector.js

**Action:**
```javascript
// Mode Selector System
// Chooses enhancement intensity based on risk analysis

const MODES = Object.freeze({
  NONE: 'none',           // Skip enhancement
  LIGHTWEIGHT: 'light',   // Quick cleanup
  STANDARD: 'standard',   // Normal enhancement
  COMPREHENSIVE: 'full'   // Full cognitive enhancement
});

const THRESHOLDS = Object.freeze({
  none: 10,       // Below 10: skip
  light: 30,      // 10-29: lightweight
  standard: 60,   // 30-59: standard
  full: 100       // 60+: comprehensive
});

const MODE_CONFIGS = Object.freeze({
  [MODES.NONE]: {
    thinking: false,
    templates: false,
    timeout: 0,
    description: 'No enhancement - pass through'
  },
  [MODES.LIGHTWEIGHT]: {
    thinking: false,
    templates: true,
    timeout: 1000,
    description: 'Quick template-based enhancement'
  },
  [MODES.STANDARD]: {
    thinking: true,
    templates: true,
    timeout: 3000,
    description: 'Standard enhancement with thinking'
  },
  [MODES.COMPREHENSIVE]: {
    thinking: true,
    templates: true,
    timeout: 5000,
    description: 'Full cognitive enhancement'
  }
});

module.exports = { MODES, THRESHOLDS, MODE_CONFIGS };
```

**Verify:** Constants are frozen and immutable

**Done:** Mode constants and thresholds defined

---

## Task 2: Implement Mode Selection Logic

**Files:** lib/prompt-enhancer/mode-selector.js

**Action:**
```javascript
/**
 * Select enhancement mode based on risk score
 * @param {number} riskScore - Risk score from 0-100
 * @param {object} options - Override options
 * @returns {string} Selected mode
 */
function selectMode(riskScore, options = {}) {
  // Handle override flags
  if (options.forceMode) {
    return validateMode(options.forceMode);
  }
  
  if (options.disableEnhancement || options.skipEnhance) {
    return MODES.NONE;
  }
  
  // Handle YOLO mode - use standard unless high risk
  if (options.yolo) {
    return riskScore > 70 ? MODES.COMPREHENSIVE : MODES.STANDARD;
  }
  
  // Threshold-based selection
  if (riskScore < THRESHOLDS.none) return MODES.NONE;
  if (riskScore < THRESHOLDS.light) return MODES.LIGHTWEIGHT;
  if (riskScore < THRESHOLDS.standard) return MODES.STANDARD;
  return MODES.COMPREHENSIVE;
}

function validateMode(mode) {
  const validModes = Object.values(MODES);
  return validModes.includes(mode) ? mode : MODES.NONE;
}

module.exports = { selectMode, validateMode };
```

**Verify:** `selectMode(5)` returns 'none', `selectMode(75)` returns 'full'

**Done:** Mode selection logic implemented

---

## Task 3: Implement Mode Configuration

**Files:** lib/prompt-enhancer/mode-selector.js

**Action:**
```javascript
/**
 * Get configuration for a specific mode
 * @param {string} mode - Mode name
 * @returns {object} Mode configuration
 */
function getModeConfig(mode) {
  return MODE_CONFIGS[mode] || MODE_CONFIGS[MODES.NONE];
}

/**
 * Check if mode requires thinking server
 * @param {string} mode - Mode name
 * @returns {boolean}
 */
function requiresThinking(mode) {
  const config = getModeConfig(mode);
  return config.thinking === true;
}

/**
 * Get timeout for mode
 * @param {string} mode - Mode name
 * @returns {number} Timeout in milliseconds
 */
function getModeTimeout(mode) {
  const config = getModeConfig(mode);
  return config.timeout;
}

/**
 * Get all available modes
 * @returns {string[]} Array of mode names
 */
function getAvailableModes() {
  return Object.values(MODES);
}

module.exports = { 
  getModeConfig, 
  requiresThinking, 
  getModeTimeout,
  getAvailableModes 
};
```

**Verify:** `getModeConfig('full').thinking` returns `true`

**Done:** Mode configuration functions implemented

---

## Task 4: Add Context-Aware Mode Selection

**Files:** lib/prompt-enhancer/mode-selector.js

**Action:**
```javascript
/**
 * Select mode with additional context awareness
 * @param {number} riskScore - Risk score from 0-100
 * @param {object} context - Additional context
 * @returns {string} Selected mode
 */
function selectModeWithContext(riskScore, context = {}) {
  const { prompt, isAutomatic, hasCode, isUrl, userPreferences } = context;
  
  // Always skip for URLs and code-only prompts
  if (isUrl || hasCode) {
    return MODES.NONE;
  }
  
  // Automatic mode - use standard unless high risk
  if (isAutomatic) {
    return riskScore > 70 ? MODES.COMPREHENSIVE : MODES.STANDARD;
  }
  
  // User preference override
  if (userPreferences?.defaultMode) {
    return validateMode(userPreferences.defaultMode);
  }
  
  // Standard threshold-based selection
  return selectMode(riskScore, context);
}

/**
 * Analyze prompt for mode selection hints
 * @param {string} prompt - User prompt
 * @returns {object} Analysis hints
 */
function analyzePromptForMode(prompt) {
  const lowerPrompt = prompt.toLowerCase();
  
  return {
    hasCode: prompt.includes('```') || 
             prompt.includes('function') ||
             prompt.includes('const ') ||
             prompt.includes('import '),
    isUrl: /^https?:\/\//i.test(prompt.trim()),
    isQuestion: prompt.includes('?'),
    isCommand: lowerPrompt.startsWith('implement') ||
               lowerPrompt.startsWith('create') ||
               lowerPrompt.startsWith('build'),
    isAutomatic: /\b(auto|automatic|yolo|just do it|go ahead)\b/i.test(prompt)
  };
}

module.exports = { selectModeWithContext, analyzePromptForMode };
```

**Verify:** Context-aware selection works correctly

**Done:** Context-aware mode selection implemented

---

## Task 5: Add Unit Tests

**Files:** lib/prompt-enhancer/__tests__/mode-selector.test.js

**Action:**
```javascript
const { 
  selectMode, 
  getModeConfig, 
  MODES, 
  THRESHOLDS 
} = require('../mode-selector');

describe('Mode Selector', () => {
  test('returns NONE for low scores', () => {
    expect(selectMode(0)).toBe(MODES.NONE);
    expect(selectMode(5)).toBe(MODES.NONE);
    expect(selectMode(9)).toBe(MODES.NONE);
  });
  
  test('returns LIGHTWEIGHT for low-mid scores', () => {
    expect(selectMode(10)).toBe(MODES.LIGHTWEIGHT);
    expect(selectMode(20)).toBe(MODES.LIGHTWEIGHT);
    expect(selectMode(29)).toBe(MODES.LIGHTWEIGHT);
  });
  
  test('returns STANDARD for mid scores', () => {
    expect(selectMode(30)).toBe(MODES.STANDARD);
    expect(selectMode(50)).toBe(MODES.STANDARD);
    expect(selectMode(59)).toBe(MODES.STANDARD);
  });
  
  test('returns COMPREHENSIVE for high scores', () => {
    expect(selectMode(60)).toBe(MODES.COMPREHENSIVE);
    expect(selectMode(80)).toBe(MODES.COMPREHENSIVE);
    expect(selectMode(100)).toBe(MODES.COMPREHENSIVE);
  });
  
  test('respects forceMode override', () => {
    expect(selectMode(100, { forceMode: 'none' })).toBe(MODES.NONE);
    expect(selectMode(0, { forceMode: 'full' })).toBe(MODES.COMPREHENSIVE);
  });
  
  test('respects disableEnhancement flag', () => {
    expect(selectMode(100, { disableEnhancement: true })).toBe(MODES.NONE);
  });
  
  test('getModeConfig returns correct config', () => {
    const config = getModeConfig(MODES.COMPREHENSIVE);
    expect(config.thinking).toBe(true);
    expect(config.timeout).toBe(5000);
  });
});
```

**Verify:** All tests pass

**Done:** Unit tests validate mode selection

---

## Task 6: Update Index Exports

**Files:** lib/prompt-enhancer/index.js

**Action:**
Add mode selector exports to index:
```javascript
const { 
  selectMode, 
  selectModeWithContext,
  getModeConfig,
  requiresThinking,
  getModeTimeout,
  getAvailableModes,
  validateMode,
  analyzePromptForMode,
  MODES, 
  THRESHOLDS,
  MODE_CONFIGS 
} = require('./mode-selector');

module.exports = {
  // ... existing exports
  // Mode Selection
  selectMode,
  selectModeWithContext,
  getModeConfig,
  requiresThinking,
  getModeTimeout,
  getAvailableModes,
  validateMode,
  analyzePromptForMode,
  MODES,
  THRESHOLDS,
  MODE_CONFIGS
};
```

**Verify:** All mode functions exported correctly

**Done:** Index updated with mode selector exports

</tasks>

<verification>
- [ ] MODES constant contains NONE, LIGHTWEIGHT, STANDARD, COMPREHENSIVE
- [ ] THRESHOLDS define correct score boundaries
- [ ] selectMode() returns correct mode for each threshold range
- [ ] getModeConfig() returns correct configuration
- [ ] Context-aware selection considers prompt type
- [ ] All unit tests pass
</verification>

<success_criteria>
- [ ] Mode selector chooses enhancement intensity based on risk score
- [ ] Four modes available: NONE, LIGHTWEIGHT, STANDARD, COMPREHENSIVE
- [ ] Override flags work correctly
- [ ] Context-aware selection handles edge cases
- [ ] Unit tests validate all behavior
</success_criteria>

<output>
**Files Modified:**
- lib/prompt-enhancer/mode-selector.js (~150 lines)
- lib/prompt-enhancer/__tests__/mode-selector.test.js (~60 lines)
- lib/prompt-enhancer/index.js (updated exports)

**Total:** ~210 lines of code
</output>
