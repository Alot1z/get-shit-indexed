---
phase: 29
plan: 03
type: implementation
wave: 2
depends_on: [29-01, 29-02]
files_modified:
  - hooks/pre-tool-use/tool-redirect.js
  - hooks/pre-tool-use/mcp-checker.js
  - hooks/hooks.json
autonomous: false
must_haves:
  truths:
    - PreToolUse hook intercepts all tool calls
    - Native tools redirected to MCP equivalents
    - Warning logged when MCP tool not used
  artifacts:
    - hooks/pre-tool-use/tool-redirect.js:100
    - hooks/pre-tool-use/mcp-checker.js:60
    - hooks/hooks.json:30
  key_links:
    - from: hooks.json:preToolUse
      to: tool-redirect.js:main()
      via: hook registration
    - from: tool-redirect.js:redirectTool()
      to: lib/tool-priority/mapper.ts
      via: import
---

# 29-03: PreToolUse Hook Enforcement

## Objective
Create PreToolUse hook that intercepts tool calls and redirects to MCP equivalents when available.

## Tasks

### Task 1: Tool Redirect Hook
**File**: `hooks/pre-tool-use/tool-redirect.js`
**Action**: Create hook that redirects native tools to MCP

```javascript
const { getMCPAlternative, shouldUseMCP, TOOL_MAPPINGS } = require('../../lib/tool-priority');

const NATIVE_TOOLS = ['Read', 'Write', 'Edit', 'Grep', 'Glob'];

module.exports = async function preToolUse(context) {
  const { tool, parameters, settings } = context;
  
  // Check if this is a native tool that should be redirected
  if (!NATIVE_TOOLS.includes(tool)) {
    return { proceed: true };
  }
  
  // Get MCP alternative
  const mapping = getMCPAlternative(tool);
  
  if (!mapping) {
    return { 
      proceed: true,
      warning: `No MCP alternative for ${tool}`
    };
  }
  
  // Check if MCP server is available
  const mcpAvailable = await checkMCPAvailable(mapping.mcpServer);
  
  if (!mcpAvailable) {
    return { 
      proceed: true,
      warning: `MCP server ${mapping.mcpServer} not available, using native ${tool}`
    };
  }
  
  // Redirect to MCP tool
  console.log(`[GSI] Redirecting ${tool} â†’ ${mapping.mcpAlternative} (70% token savings)`);
  
  return {
    proceed: true,
    redirect: {
      tool: mapping.mcpAlternative,
      parameters: mapParameters(tool, parameters, mapping.mcpAlternative)
    }
  };
};

function mapParameters(nativeTool, params, mcpTool) {
  // Handle parameter name differences
  if (nativeTool === 'Read') {
    return { path: params.file_path };
  }
  if (nativeTool === 'Write') {
    return { path: params.file_path, content: params.content };
  }
  if (nativeTool === 'Edit') {
    return { 
      file_path: params.file_path, 
      old_string: params.old_string, 
      new_string: params.new_string 
    };
  }
  // ... more mappings
  return params;
}

async function checkMCPAvailable(serverName) {
  // Check if MCP server is connected
  try {
    // This would check actual MCP server availability
    return true;
  } catch {
    return false;
  }
}
```

**Done**:
- [ ] Hook intercepts all tools
- [ ] Parameter mapping complete
- [ ] MCP availability check works

### Task 2: MCP Checker Utility
**File**: `hooks/pre-tool-use/mcp-checker.js`
**Action**: Check MCP server availability

```javascript
const MCP_SERVERS = {
  'desktop-commander': { tools: 24, connected: false },
  'code-index-mcp': { tools: 10, connected: false }
};

async function checkAllServers() {
  for (const [name, config] of Object.entries(MCP_SERVERS)) {
    try {
      // Ping MCP server
      config.connected = await pingServer(name);
    } catch {
      config.connected = false;
    }
  }
  return MCP_SERVERS;
}

async function pingServer(name) {
  // Implementation depends on MCP server connection method
  return true;
}

module.exports = { checkAllServers, MCP_SERVERS };
```

**Done**:
- [ ] Server status tracked
- [ ] Availability check works

### Task 3: Hook Registration
**File**: `hooks/hooks.json`
**Action**: Register PreToolUse hook

```json
{
  "hooks": {
    "preToolUse": [
      {
        "matcher": ".*",
        "hooks": ["./pre-tool-use/tool-redirect.js"]
      }
    ]
  }
}
```

**Done**:
- [ ] Hook registered
- [ ] Matcher catches all tools

## Output

PreToolUse hook that enforces MCP tool usage.

**Next**: 29-04 - Configuration Sync System
