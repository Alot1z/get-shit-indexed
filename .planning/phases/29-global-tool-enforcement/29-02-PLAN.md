---
phase: 29
plan: 02
type: implementation
wave: 1
depends_on: []
files_modified:
  - lib/tool-priority/rules.ts
  - lib/tool-priority/mapper.ts
  - lib/tool-priority/index.ts
autonomous: true
must_haves:
  truths:
    - Tool priority rules defined: Skills → MCP → Native
    - Mapping table maps native tools to MCP equivalents
    - Priority checker returns best available tool
  artifacts:
    - lib/tool-priority/rules.ts:80
    - lib/tool-priority/mapper.ts:120
    - lib/tool-priority/index.ts:40
  key_links:
    - from: mapper.ts:getMCPAlternative()
      to: rules.ts:TOOL_PRIORITY
      via: priority check
---

# 29-02: Tool Priority Rules System

## Objective
Create tool priority system that defines which tools to use and provides MCP alternatives for native tools.

## Tasks

### Task 1: Priority Rules Definition
**File**: `lib/tool-priority/rules.ts`
**Action**: Define tool priority hierarchy

```typescript
export type ToolCategory = 'skill' | 'mcp' | 'native';

export interface ToolPriority {
  category: ToolCategory;
  priority: number; // Lower = higher priority
  tokenSavings: number; // Percentage savings vs native
}

export const TOOL_PRIORITY: Record<ToolCategory, ToolPriority> = {
  skill: { category: 'skill', priority: 1, tokenSavings: 90 },
  mcp: { category: 'mcp', priority: 2, tokenSavings: 70 },
  native: { category: 'native', priority: 3, tokenSavings: 0 }
};

// Tools that should NEVER be used when MCP available
export const BLOCKED_WHEN_MCP_AVAILABLE = [
  'Read',
  'Write', 
  'Edit',
  'Grep',
  'Glob'
];
```

**Done**:
- [ ] Priority rules defined
- [ ] Blocked tools listed
- [ ] Type exports ready

### Task 2: Tool Mapper
**File**: `lib/tool-priority/mapper.ts`
**Action**: Map native tools to MCP equivalents

```typescript
import { TOOL_PRIORITY, BLOCKED_WHEN_MCP_AVAILABLE } from './rules.js';

export interface ToolMapping {
  nativeTool: string;
  mcpAlternative: string;
  mcpServer: 'desktop-commander' | 'code-index-mcp';
  available: boolean;
}

export const TOOL_MAPPINGS: ToolMapping[] = [
  // Desktop Commander mappings
  { nativeTool: 'Read', mcpAlternative: 'mcp__desktop-commander__read_file', mcpServer: 'desktop-commander', available: true },
  { nativeTool: 'Write', mcpAlternative: 'mcp__desktop-commander__write_file', mcpServer: 'desktop-commander', available: true },
  { nativeTool: 'Edit', mcpAlternative: 'mcp__desktop-commander__edit_block', mcpServer: 'desktop-commander', available: true },
  { nativeTool: 'Bash ls', mcpAlternative: 'mcp__desktop-commander__list_directory', mcpServer: 'desktop-commander', available: true },
  { nativeTool: 'Bash mkdir', mcpAlternative: 'mcp__desktop-commander__create_directory', mcpServer: 'desktop-commander', available: true },
  { nativeTool: 'Bash cat', mcpAlternative: 'mcp__desktop-commander__read_file', mcpServer: 'desktop-commander', available: true },
  
  // Code-Index mappings
  { nativeTool: 'Grep', mcpAlternative: 'mcp__code-index-mcp__search_code_advanced', mcpServer: 'code-index-mcp', available: true },
  { nativeTool: 'Glob', mcpAlternative: 'mcp__code-index-mcp__find_files', mcpServer: 'code-index-mcp', available: true },
];

export function getMCPAlternative(nativeTool: string): ToolMapping | null {
  return TOOL_MAPPINGS.find(m => m.nativeTool === nativeTool) ?? null;
}

export function shouldUseMCP(toolName: string, mcpAvailable: boolean): boolean {
  if (!mcpAvailable) return false;
  return BLOCKED_WHEN_MCP_AVAILABLE.includes(toolName);
}

export function getBestTool(nativeTool: string, availableTools: string[]): string {
  const mapping = getMCPAlternative(nativeTool);
  
  // Check if MCP alternative is available
  if (mapping && availableTools.includes(mapping.mcpAlternative)) {
    return mapping.mcpAlternative;
  }
  
  // Fallback to native
  return nativeTool;
}
```

**Done**:
- [ ] All mappings defined
- [ ] Lookup functions work
- [ ] Fallback logic correct

### Task 3: Index Export
**File**: `lib/tool-priority/index.ts`
**Action**: Export all functions

```typescript
export * from './rules.js';
export * from './mapper.js';

// Convenience function
export function enforceToolPriority(requestedTool: string): { 
  useTool: string; 
  reason: string;
  tokenSavings: number;
} {
  const mapping = getMCPAlternative(requestedTool);
  
  if (mapping) {
    return {
      useTool: mapping.mcpAlternative,
      reason: `MCP tool ${mapping.mcpAlternative} saves ~70% tokens vs ${requestedTool}`,
      tokenSavings: 70
    };
  }
  
  return {
    useTool: requestedTool,
    reason: 'No MCP alternative available',
    tokenSavings: 0
  };
}
```

**Done**:
- [ ] Clean exports
- [ ] Convenience function works

## Output

Tool priority system with complete mappings.

**Next**: 29-03 - PreToolUse Hook Enforcement
