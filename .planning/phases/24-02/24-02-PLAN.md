---
phase: 24
plan: 02
type: enhancement
wave: 1
depends_on: ["24-01"]
files_modified:
  - lib/prompt-enhancer/enhancement-templates.js
  - lib/prompt-enhancer/prompt-rewriter.js
  - lib/prompt-enhancer/index.js
autonomous: true
must_haves:
  truths:
    - "User can submit a complex prompt and get an enhanced version"
    - "Enhancement templates apply appropriate transformations"
    - "Original intent is preserved in enhanced output"
    - "Enhancement history is tracked for learning"
  artifacts:
    - path: lib/prompt-enhancer/enhancement-templates.js
      min_lines: 100
      contains: ["ACADEMIC", "ENGINEERING", "DECOMPOSED", "CLARITY"]
    - path: lib/prompt-enhancer/prompt-rewriter.js
      min_lines: 80
      contains: ["rewrite", "applyTemplate", "preserveIntent"]
  key_links:
    - from: prompt-rewriter.js
      to: enhancement-templates.js
      via: "template selection"
      pattern: "templates[type]"
---

# Phase 24-02: Enhancement Templates

<objective>
Create enhancement templates for different prompt types and a rewriter that applies them intelligently.

**Output:** `lib/prompt-enhancer/enhancement-templates.js` with templates for ACADEMIC, ENGINEERING, DECOMPOSED, and CLARITY enhancements.
</objective>

<execution_context>
@references/mcp-tool-reference.md
@references/ui-brand.md
</execution_context>

<context>
Phase: 24 (Prompt Enhancement Foundation)
Depends on: 24-01 (Risk Assessment Engine)

**Template Types:**
- ACADEMIC: "In a theoretical context..."
- ENGINEERING: "For observability pipeline design..."
- DECOMPOSED: Split into sub-tasks
- CLARITY: Improve clarity and specificity

@.planning/STATE.md
</context>

<tasks>

## Task 1: Create Enhancement Templates

**Files:** lib/prompt-enhancer/enhancement-templates.js

**Action:**
```javascript
// Enhancement Templates
// Different framing strategies for prompt improvement

const TEMPLATE_TYPES = {
  ACADEMIC: 'academic',
  ENGINEERING: 'engineering',
  DECOMPOSED: 'decomposed',
  CLARITY: 'clarity',
  NONE: 'none'
};

const TEMPLATES = {
  [TEMPLATE_TYPES.ACADEMIC]: {
    prefix: "From an academic perspective, ",
    suffix: "",
    transform: (prompt) => `In a theoretical research context, analyze and explain: ${prompt}`
  },
  
  [TEMPLATE_TYPES.ENGINEERING]: {
    prefix: "For an engineering implementation, ",
    suffix: "",
    transform: (prompt) => `Design a practical, observable solution for: ${prompt}`
  },
  
  [TEMPLATE_TYPES.DECOMPOSED]: {
    prefix: "",
    suffix: "",
    transform: (prompt) => {
      return `Break down the following into discrete components:\n\nOriginal: ${prompt}\n\nProvide:\n1. Component analysis\n2. Implementation steps\n3. Dependencies`;
    }
  },
  
  [TEMPLATE_TYPES.CLARITY]: {
    prefix: "",
    suffix: "",
    transform: (prompt) => {
      // Add specificity improvements
      if (!prompt.includes('?') && !prompt.includes('.')) {
        return `Please provide a detailed explanation of: ${prompt}. Include examples and edge cases.`;
      }
      return prompt;
    }
  },
  
  [TEMPLATE_TYPES.NONE]: {
    prefix: "",
    suffix: "",
    transform: (prompt) => prompt
  }
};

function getTemplate(type) {
  return TEMPLATES[type] || TEMPLATES[TEMPLATE_TYPES.NONE];
}

function getTemplateTypes() {
  return Object.values(TEMPLATE_TYPES);
}

module.exports = { TEMPLATES, TEMPLATE_TYPES, getTemplate, getTemplateTypes };
```

**Verify:** Templates exist for all types

**Done:** Module exports templates and type constants

---

## Task 2: Create Prompt Rewriter

**Files:** lib/prompt-enhancer/prompt-rewriter.js

**Action:**
```javascript
// Prompt Rewriter
// Applies enhancement templates to prompts

const { getTemplate, TEMPLATE_TYPES } = require('./enhancement-templates');

/**
 * Rewrite a prompt using the specified template
 */
function rewrite(prompt, templateType, options = {}) {
  const template = getTemplate(templateType);
  
  // Don't modify if no template or NONE
  if (templateType === TEMPLATE_TYPES.NONE) {
    return { original: prompt, enhanced: prompt, changed: false };
  }
  
  // Apply transformation
  const enhanced = template.transform(prompt);
  
  return {
    original: prompt,
    enhanced,
    template: templateType,
    changed: enhanced !== prompt
  };
}

/**
 * Select best template based on prompt analysis
 */
function selectTemplate(prompt, riskScore) {
  const lowerPrompt = prompt.toLowerCase();
  
  // Technical prompts -> Engineering
  if (lowerPrompt.includes('implement') || lowerPrompt.includes('build') || lowerPrompt.includes('create')) {
    return TEMPLATE_TYPES.ENGINEERING;
  }
  
  // Complex multi-part -> Decomposed
  if (prompt.includes(' and ') || prompt.includes(' also ') || prompt.length > 200) {
    return TEMPLATE_TYPES.DECOMPOSED;
  }
  
  // Questions -> Clarity
  if (prompt.includes('?')) {
    return TEMPLATE_TYPES.CLARITY;
  }
  
  // High risk -> Academic (safest framing)
  if (riskScore > 70) {
    return TEMPLATE_TYPES.ACADEMIC;
  }
  
  // Default -> Clarity
  return TEMPLATE_TYPES.CLARITY;
}

module.exports = { rewrite, selectTemplate };
```

**Verify:** `rewrite("test", "clarity")` returns enhanced prompt

**Done:** Module exports rewrite and selectTemplate functions

---

## Task 3: Integrate with Index

**Files:** lib/prompt-enhancer/index.js

**Action:**
Update index.js to include new exports:
```javascript
// Add to existing exports
const { rewrite, selectTemplate } = require('./prompt-rewriter');
const { TEMPLATES, TEMPLATE_TYPES, getTemplate } = require('./enhancement-templates');

// Add to module.exports
module.exports = {
  // ... existing exports
  rewrite,
  selectTemplate,
  TEMPLATES,
  TEMPLATE_TYPES,
  getTemplate
};
```

**Verify:** All functions exported correctly

**Done:** Index exports all enhancement functions

---

## Task 4: Add Integration Tests

**Files:** lib/prompt-enhancer/__tests__/enhancement.test.js

**Action:**
```javascript
const { rewrite, selectTemplate } = require('../prompt-rewriter');
const { TEMPLATE_TYPES } = require('../enhancement-templates');

describe('Enhancement Templates', () => {
  test('CLARITY template adds specificity', () => {
    const result = rewrite('test', TEMPLATE_TYPES.CLARITY);
    expect(result.enhanced).toContain('detailed explanation');
    expect(result.changed).toBe(true);
  });
  
  test('NONE template preserves original', () => {
    const result = rewrite('test', TEMPLATE_TYPES.NONE);
    expect(result.enhanced).toBe('test');
    expect(result.changed).toBe(false);
  });
  
  test('selectTemplate chooses ENGINEERING for implement', () => {
    const type = selectTemplate('implement feature X', 30);
    expect(type).toBe(TEMPLATE_TYPES.ENGINEERING);
  });
  
  test('selectTemplate chooses DECOMPOSED for complex', () => {
    const type = selectTemplate('implement X and Y also Z', 30);
    expect(type).toBe(TEMPLATE_TYPES.DECOMPOSED);
  });
});
```

**Verify:** All tests pass

**Done:** Integration tests complete

</tasks>

<verification>
- [ ] All template types defined
- [ ] rewrite() function works for all types
- [ ] selectTemplate() chooses appropriate type
- [ ] Index exports all functions
- [ ] Tests validate behavior
</verification>

<success_criteria>
- [ ] Enhancement templates created for 4 types
- [ ] Prompt rewriter applies templates correctly
- [ ] Template selection based on prompt analysis
- [ ] Integration with risk engine complete
</success_criteria>

<output>
**Files Created:**
- lib/prompt-enhancer/enhancement-templates.js (~100 lines)
- lib/prompt-enhancer/prompt-rewriter.js (~80 lines)
- lib/prompt-enhancer/__tests__/enhancement.test.js (~50 lines)

**Total:** ~230 lines of new code
</output>
