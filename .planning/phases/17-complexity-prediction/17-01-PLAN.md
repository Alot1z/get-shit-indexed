---
phase: 17-complexity-prediction
plan: 01
name: Model Awareness System (Layer 1)
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/model-specs.json
  - .planning/.last-model
  - lib/complexity/model-awareness.js
  - lib/complexity/index.js
autonomous: true
estimated_tasks: 7
must_haves:
  truths:
    - "Model detection works without internet search"
    - "Model specs load from local cache"
    - "Model change detection triggers threshold reload"
    - "Thresholds are model-specific (haiku/sonnet/opus)"
  artifacts:
    - path: ".planning/model-specs.json"
      provides: "Model capability specifications"
      contains: "context_window, thresholds"
    - path: "lib/complexity/model-awareness.js"
      provides: "Model detection and spec loading"
      exports: ["detectCurrentModel", "loadModelSpecs", "getModelThresholds"]
  key_links:
    - from: "lib/complexity/model-awareness.js"
      to: ".planning/model-specs.json"
      via: "dc.read_file"
      pattern: "read_file.*model-specs"
---

<objective>
Create Layer 1 of the Three-Layer Intelligence architecture: Model Awareness System.

Purpose: Enable GSI to auto-detect the current Claude model and load appropriate complexity thresholds without user input or internet search. This is the foundation layer that all other complexity predictions depend on.

Output: A working model detection module that reads local cache, detects model changes, and provides model-specific thresholds.
</objective>

<execution_context>
@~/.claude/get-shit-indexed/workflows/execute-plan.md
@~/.claude/get-shit-indexed/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-complexity-prediction/17-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create model-specs.json with Claude model specifications</name>
  <files>.planning/model-specs.json</files>
  <action>
Create the local model specifications cache file with entries for:
- claude-sonnet-4-5-20250929: context_window=200000, safe_threshold=50, warn_threshold=80, split_threshold=80
- claude-opus-4-6: context_window=200000, safe_threshold=60, warn_threshold=85, split_threshold=85
- claude-haiku-4-5-20251001: context_window=200000, safe_threshold=40, warn_threshold=70, split_threshold=70
- default (fallback): context_window=200000, safe_threshold=40, warn_threshold=70, split_threshold=70

Include avg_token_per_file=3000 and avg_token_per_task=15000 for all models.
Keep the file compressed (~500 bytes target).
  </action>
  <verify>mcp__desktop-commander__read_file path=".planning/model-specs.json" returns valid JSON with all 4 model entries</verify>
  <done>model-specs.json exists with haiku, sonnet, opus, and default entries with thresholds</done>
</task>

<task type="auto">
  <name>Task 2: Create lib/complexity directory structure</name>
  <files>lib/complexity/index.js, lib/complexity/model-awareness.js</files>
  <action>
Create the directory structure for the complexity prediction system:
- Create lib/complexity/ directory if not exists
- Create lib/complexity/index.js as main entry point (exports from model-awareness.js)
- Create lib/complexity/model-awareness.js stub with module structure

Use mcp__desktop-commander__create_directory for lib/complexity.
  </action>
  <verify>mcp__desktop-commander__list_directory path="lib/complexity" shows both files</verify>
  <done>lib/complexity/ directory exists with index.js and model-awareness.js</done>
</task>

<task type="auto">
  <name>Task 3: Implement detectCurrentModel function</name>
  <files>lib/complexity/model-awareness.js</files>
  <action>
Implement the model detection function with three fallback strategies:

```javascript
async function detectCurrentModel() {
  // Strategy 1: Environment variable
  const envModel = process.env.CLAUDE_MODEL;
  if (envModel) return envModel;

  // Strategy 2: Config.json profile model
  const config = await dc.read_file(".planning/config.json");
  const profileModel = config.profiles?.[config.active_profile]?.model;
  if (profileModel) return profileModel;

  // Strategy 3: Default fallback
  return "claude-sonnet-4-5-20250929";
}
```

Use Desktop Commander MCP for file reading. Export the function.
  </action>
  <verify>Function detectCurrentModel exists and returns a model ID string</verify>
  <done>detectCurrentModel function implemented with 3-strategy detection</done>
</task>

<task type="auto">
  <name>Task 4: Implement loadModelSpecs function</name>
  <files>lib/complexity/model-awareness.js</files>
  <action>
Implement the model specs loader that reads from local cache:

```javascript
async function loadModelSpecs(modelId) {
  const specs = JSON.parse(await dc.read_file(".planning/model-specs.json"));
  return specs[modelId] || specs["default"];
}
```

Include error handling for missing file (return default specs).
Export the function.
  </action>
  <verify>Function loadModelSpecs returns correct thresholds for known model IDs</verify>
  <done>loadModelSpecs function loads model specs from local JSON cache</done>
</task>

<task type="auto">
  <name>Task 5: Implement model change detection</name>
  <files>lib/complexity/model-awareness.js, .planning/.last-model</files>
  <action>
Implement model change detection that:
1. Reads .planning/.last-model if it exists
2. Compares with current model ID
3. Logs change if different: `Model changed: {old} -> {new}`
4. Updates .planning/.last-model with current model ID
5. Returns boolean indicating if model changed

Create the detectModelChange function and ensure it uses Desktop Commander for file I/O.
  </action>
  <verify>detectModelChange returns true when model changes, false otherwise</verify>
  <done>Model change detection implemented with .last-model tracking</done>
</task>

<task type="auto">
  <name>Task 6: Implement getModelThresholds convenience function</name>
  <files>lib/complexity/model-awareness.js</files>
  <action>
Implement a convenience function that combines detection and loading:

```javascript
async function getModelThresholds() {
  const modelId = await detectCurrentModel();
  const changed = await detectModelChange(modelId);
  const specs = await loadModelSpecs(modelId);
  return { modelId, changed, ...specs };
}
```

This is the main entry point for other modules to get thresholds.
  </action>
  <verify>getModelThresholds returns object with modelId, changed flag, and all threshold values</verify>
  <done>getModelThresholds convenience function combines all model awareness operations</done>
</task>

<task type="auto">
  <name>Task 7: Create index.js entry point</name>
  <files>lib/complexity/index.js</files>
  <action>
Create the main entry point that exports all Layer 1 functions:

```javascript
module.exports = {
  detectCurrentModel,
  loadModelSpecs,
  detectModelChange,
  getModelThresholds
};
```

Import from ./model-awareness.js and re-export for clean API.
  </action>
  <verify>require('./lib/complexity') returns object with all 4 functions</verify>
  <done>index.js exports all Layer 1 functions for clean imports</done>
</task>

</tasks>

<verification>
Verify Layer 1 completion by running:
1. mcp__desktop-commander__read_file(".planning/model-specs.json") - should return valid JSON
2. mcp__desktop-commander__read_file("lib/complexity/model-awareness.js") - should contain all 4 functions
3. Check that model detection logic handles all 3 fallback strategies
</verification>

<success_criteria>
- [ ] model-specs.json created with 4 model entries (haiku, sonnet, opus, default)
- [ ] lib/complexity/ directory created
- [ ] detectCurrentModel function with 3-strategy detection
- [ ] loadModelSpecs function reads from local cache
- [ ] detectModelChange tracks model changes in .last-model
- [ ] getModelThresholds combines all operations
- [ ] index.js exports clean API
</success_criteria>

<output>
After completion, create `.planning/phases/17-complexity-prediction/17-01-SUMMARY.md` documenting:
- Model detection strategies implemented
- Threshold values for each model
- File structure created
- Integration points for Layer 2
</output>
