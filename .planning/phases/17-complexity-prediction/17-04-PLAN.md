---
phase: 17-complexity-prediction
plan: 04
name: Auto-Split Decision Engine (Layer 3)
type: execute
wave: 2
depends_on:
  - 17-01
  - 17-02
  - 17-03
files_modified:
  - lib/complexity/auto-split.js
  - lib/complexity/warning-system.js
autonomous: true
estimated_tasks: 7
must_haves:
  truths:
    - "Auto-split triggers when score exceeds model-specific threshold"
    - "Warning system offers options (proceed/split/manual)"
    - "User can override auto-split with explicit approval"
    - "Split recommendations include sub-phase count"
  artifacts:
    - path: "lib/complexity/auto-split.js"
      provides: "Auto-split decision engine"
      exports: ["executeAutoSplit", "calculateSubPhaseCount", "splitPlan"]
    - path: "lib/complexity/warning-system.js"
      provides: "User warning and override system"
      exports: ["generateWarning", "handleUserResponse"]
  key_links:
    - from: "lib/complexity/auto-split.js"
      to: "lib/complexity/model-awareness.js"
      via: "getModelThresholds"
    - from: "lib/complexity/warning-system.js"
      to: "lib/complexity/auto-split.js"
      via: "executeAutoSplit"
---

<objective>
Implement Layer 3: Auto-Split Decision Engine that automatically splits high-complexity plans into sub-phases.

Purpose: Automatically handle complexity overflow by splitting plans into manageable sub-phases, with user warnings for borderline cases.

Output: A working auto-split system that calculates sub-phase counts, splits plans, and warns users with options.
</objective>

<execution_context>
@C:/Users/mose/.claude/get-shit-indexed/workflows/execute-plan.md
@C:/Users/moe/.claude/get-shit-indexed/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-complexity-prediction/17-CONTEXT.md
@.planning/phases/17-complexity-prediction/17-01-PLAN.md
@.planning/phases/17-complexity-prediction/17-02-PLAN.md
@.planning/phases/17-complexity-prediction/17-03-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create calculateSubPhaseCount function</name>
  <files>lib/complexity/auto-split.js</files>
  <action>
Create the sub-phase calculation function that determines how many sub-phases to create:

```javascript
const { getModelThresholds } = require('./model-awareness');

async function calculateSubPhaseCount(score) {
  const thresholds = await getModelThresholds();
  
  if (score <= thresholds.split_threshold) {
    return 1; // No split needed
  }
  
  // Calculate how many sub-phases needed
  const subPhaseCount = Math.ceil(score / thresholds.split_threshold);
  
  // Cap at reasonable maximum (avoid over-fragmentation)
  const maxSubPhases = 5;
  return Math.min(subPhaseCount, maxSubPhases);
}

module.exports = { calculateSubPhaseCount };
```

The function uses model-specific thresholds from Layer 1.
  </action>
  <verify>calculateSubPhaseCount(150) returns 2 (for default threshold 80)</verify>
  <done>calculateSubPhaseCount uses model thresholds to determine split count</done>
</task>

<task type="auto">
  <name>Task 2: Implement plan splitting logic</name>
  <files>lib/complexity/auto-split.js</files>
  <action>
Implement the plan splitting function that distributes tasks across sub-phases:

```javascript
async function splitPlan(planContent, subPhaseCount) {
  // Parse tasks from plan content
  const taskMatches = [...planContent.matchAll(/<task[^>]*>([\s\S]*?)<\/task>/g)];
  const tasks = taskMatches.map((m, i) => ({
    index: i,
    content: m[0],
    fullMatch: m[0]
  }));
  
  // Distribute tasks across sub-phases
  const tasksPerPhase = Math.ceil(tasks.length / subPhaseCount);
  const subPhases = [];
  
  for (let i = 0; i < subPhaseCount; i++) {
    const start = i * tasksPerPhase;
    const end = Math.min(start + tasksPerPhase, tasks.length);
    subPhases.push({
      phaseNumber: i + 1,
      tasks: tasks.slice(start, end),
      taskCount: end - start
    });
  }
  
  return {
    originalTaskCount: tasks.length,
    subPhaseCount,
    subPhases
  };
}

module.exports = { calculateSubPhaseCount, splitPlan };
```
  </action>
  <verify>splitPlan with 10 tasks and subPhaseCount=2 creates 2 phases with 5 tasks each</verify>
  <done>splitPlan distributes tasks evenly across sub-phases</done>
</task>

<task type="auto">
  <name>Task 3: Implement auto-split execution</name>
  <files>lib/complexity/auto-split.js</files>
  <action>
Implement the main auto-split execution function:

```javascript
const dc = require('../mcp/desktop-commander');

async function executeAutoSplit(planPath, score) {
  const subPhaseCount = await calculateSubPhaseCount(score);
  
  if (subPhaseCount === 1) {
    return { split: false, reason: "Score below split threshold" };
  }
  
  // Read original plan
  const planContent = await dc.read_file({ path: planPath });
  
  // Split the plan
  const splitResult = await splitPlan(planContent, subPhaseCount);
  
  // Generate sub-phase plan files
  const generatedPlans = [];
  const basePath = planPath.replace('-PLAN.md', '');
  
  for (const subPhase of splitResult.subPhases) {
    const subPlanPath = `${basePath}-PART${subPhase.phaseNumber.toString().padStart(2, '0')}-PLAN.md`;
    
    // Create sub-phase plan content (simplified)
    const subPlanContent = generateSubPlanContent(subPhase, planContent);
    
    // Write sub-phase plan
    await dc.write_file({ path: subPlanPath, content: subPlanContent });
    generatedPlans.push(subPlanPath);
  }
  
  return {
    split: true,
    subPhaseCount,
    generatedPlans,
    originalTaskCount: splitResult.originalTaskCount
  };
}

function generateSubPlanContent(subPhase, originalContent) {
  // Extract frontmatter from original
  const frontmatter = originalContent.match(/^---[\s\S]*?---/)?.[0] || '';
  
  return `${frontmatter}

# Auto-Split Sub-Phase ${subPhase.phaseNumber}

This plan was automatically generated by the Complexity Prediction System.

## Tasks (${subPhase.taskCount})

${subPhase.tasks.map(t => t.content).join('\n\n')}
`;
}

module.exports = { calculateSubPhaseCount, splitPlan, executeAutoSplit };
```
  </action>
  <verify>executeAutoSplit creates sub-phase plan files when score exceeds threshold</verify>
  <done>executeAutoSplit creates and writes sub-phase plan files</done>
</task>

<task type="auto">
  <name>Task 4: Create warning system module</name>
  <files>lib/complexity/warning-system.js</files>
  <action>
Create the warning system for borderline complexity scores:

```javascript
const { getModelThresholds } = require('./model-awareness');

async function generateWarning(score, planPath) {
  const thresholds = await getModelThresholds();
  
  if (score <= thresholds.warn_threshold) {
    return null; // No warning needed
  }
  
  const isCritical = score > thresholds.split_threshold;
  
  return {
    type: isCritical ? 'critical' : 'warning',
    score,
    threshold: isCritical ? thresholds.split_threshold : thresholds.warn_threshold,
    message: isCritical
      ? `Complexity score ${score} exceeds ${thresholds.split_threshold} threshold. Auto-split recommended.`
      : `Complexity score ${score} is in warning range (${thresholds.warn_threshold}-${thresholds.split_threshold}).`,
    options: [
      { id: 'proceed', label: 'Proceed anyway', risk: 'high' },
      { id: 'split', label: 'Split into sub-phases', risk: 'low', recommended: true },
      { id: 'manual', label: 'Manual review', risk: 'medium' }
    ],
    recommendation: isCritical ? 'split' : 'proceed'
  };
}

module.exports = { generateWarning };
```
  </action>
  <verify>generateWarning(60) returns warning object with options, generateWarning(30) returns null</verify>
  <done>generateWarning creates structured warnings with options for borderline scores</done>
</task>

<task type="auto">
  <name>Task 5: Implement user response handler</name>
  <files>lib/complexity/warning-system.js</files>
  <action>
Implement handler for user responses to warnings:

```javascript
const { executeAutoSplit } = require('./auto-split');

async function handleUserResponse(warning, userResponse, planPath, score) {
  switch (userResponse) {
    case 'proceed':
      return {
        action: 'proceed',
        reason: 'User approved execution despite warning',
        risk: warning.options.find(o => o.id === 'proceed')?.risk || 'high'
      };
      
    case 'split':
      const splitResult = await executeAutoSplit(planPath, score);
      return {
        action: 'split',
        reason: 'User approved auto-split',
        ...splitResult
      };
      
    case 'manual':
      return {
        action: 'manual',
        reason: 'User requested manual review',
        requiresHumanIntervention: true
      };
      
    default:
      return {
        action: 'unknown',
        reason: `Unknown response: ${userResponse}`,
        fallback: 'proceed'
      };
  }
}

module.exports = { generateWarning, handleUserResponse };
```
  </action>
  <verify>handleUserResponse with 'split' triggers executeAutoSplit</verify>
  <done>handleUserResponse processes user decisions on warnings</done>
</task>

<task type="auto">
  <name>Task 6: Add YOLO mode bypass for auto-split</name>
  <files>lib/complexity/auto-split.js</files>
  <action>
Add support for YOLO mode that bypasses warnings and auto-splits:

```javascript
async function executeAutoSplit(planPath, score, options = {}) {
  const subPhaseCount = await calculateSubPhaseCount(score);
  
  if (subPhaseCount === 1) {
    return { split: false, reason: "Score below split threshold" };
  }
  
  // YOLO mode: Auto-split without confirmation
  if (options.yoloMode) {
    console.log(`[YOLO MODE] Auto-splitting plan with score ${score} into ${subPhaseCount} sub-phases`);
    // Continue with split without warning user
  }
  
  // Normal mode: Would need user confirmation (handled by warning system)
  
  // Read original plan and proceed with split
  const planContent = await dc.read_file({ path: planPath });
  const splitResult = await splitPlan(planContent, subPhaseCount);
  
  // ... rest of split logic
}
```

Update function signature to accept options parameter.
  </action>
  <verify>executeAutoSplit with yoloMode=true skips confirmation</verify>
  <done>YOLO mode bypass enables automatic splitting without user confirmation</done>
</task>

<task type="auto">
  <name>Task 7: Update index.js with Layer 3 exports</name>
  <files>lib/complexity/index.js</files>
  <action>
Update the main index to export all Layer 3 functions:

```javascript
const modelAwareness = require('./model-awareness');
const scorer = require('./scorer');
const cognitiveFlow = require('./cognitive-flow');
const tractatusCi = require('./tractatus-ci-phase');
const sequentialCg = require('./sequential-cg-phase');
const debugDc = require('./debug-dc-phase');
const autoSplit = require('./auto-split');
const warningSystem = require('./warning-system');

module.exports = {
  // Layer 1: Model Awareness
  ...modelAwareness,
  
  // Scoring
  ...scorer,
  
  // Layer 2: Cognitive Flow
  runCognitiveFlow: cognitiveFlow.runCognitiveFlow,
  ComplexityResult: cognitiveFlow.ComplexityResult,
  
  // Individual phases
  runStructurePhase: tractatusCi.runStructurePhase,
  runProcessPhase: sequentialCg.runProcessPhase,
  runLearningPhase: debugDc.runLearningPhase,
  
  // Layer 3: Auto-Split Decision
  calculateSubPhaseCount: autoSplit.calculateSubPhaseCount,
  splitPlan: autoSplit.splitPlan,
  executeAutoSplit: autoSplit.executeAutoSplit,
  
  // Warning System
  generateWarning: warningSystem.generateWarning,
  handleUserResponse: warningSystem.handleUserResponse
};
```
  </action>
  <verify>require('./lib/complexity') exports all Layer 3 functions</verify>
  <done>Unified index.js exports all Layer 1, 2, and 3 functions</done>
</task>

</tasks>

<verification>
Verify Layer 3 completion by:
1. mcp__desktop-commander__read_file("lib/complexity/auto-split.js") - should contain calculateSubPhaseCount, splitPlan, executeAutoSplit
2. mcp__desktop-commander__read_file("lib/complexity/warning-system.js") - should contain generateWarning, handleUserResponse
3. Auto-split respects model-specific thresholds
4. Warning system provides 3 options: proceed/split/manual
5. YOLO mode bypasses confirmation
</verification>

<success_criteria>
- [ ] calculateSubPhaseCount uses model thresholds
- [ ] splitPlan distributes tasks evenly
- [ ] executeAutoSplit creates sub-phase plan files
- [ ] generateWarning creates structured warnings with options
- [ ] handleUserResponse processes user decisions
- [ ] YOLO mode bypasses confirmation
- [ ] Unified index.js exports all Layer 3 functions
</success_criteria>

<output>
After completion, create `.planning/phases/17-complexity-prediction/17-04-SUMMARY.md` documenting:
- Auto-split decision logic with model thresholds
- Sub-phase calculation formula
- Warning system with 3 options
- YOLO mode bypass behavior
- Integration with Layer 1 and Layer 2
</output>
