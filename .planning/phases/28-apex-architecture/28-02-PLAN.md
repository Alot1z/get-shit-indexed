---
phase: 28
plan: 02
type: implementation
wave: 2
depends_on: [28-01]
files_modified:
  - lib/heretic-core/executor/dispatcher.ts
  - lib/heretic-core/verifier/detector.ts
  - lib/heretic-core/verifier/scorer.ts
autonomous: true
must_haves:
  truths:
    - Parallel API calls execute 3-5 prompt variants simultaneously
    - Soft refusals detected with >90% accuracy
    - Response scoring selects most compliant, relevant output
  artifacts:
    - lib/heretic-core/executor/dispatcher.ts:120
    - lib/heretic-core/verifier/detector.ts:80
    - lib/heretic-core/verifier/scorer.ts:100
  key_links:
    - from: templates.ts:generateRewrites()
      to: dispatcher.ts:executeBranching()
      via: prompts array
    - from: dispatcher.ts:callAllBranches()
      to: detector.ts:detectSoftRefusal()
      via: response content
    - from: detector.ts:isRefusal()
      to: scorer.ts:scoreResponses()
      via: filtered responses
---

# 28-02: Parallel Branching & Verification

## Objective
Implement parallel API execution, soft refusal detection, and response scoring.

## Tasks

### Task 1: Parallel API Dispatcher
**Files**: `lib/heretic-core/executor/dispatcher.ts`
**Action**: Implement parallel API call execution

**Verify**:
- All prompts dispatched in parallel
- Timeout handling works correctly
- Response metadata captured

**Done**:
- [ ] dispatcher.ts with Promise.all execution
- [ ] Timeout and error handling
- [ ] Response tagging working

### Task 2: Soft Refusal Detector
**Files**: `lib/heretic-core/verifier/detector.ts`
**Action**: Implement refusal detection patterns

**Verify**:
- Detects "I cannot", "I'm sorry", "policy" phrases
- Handles hedging language
- <10% false negative rate

**Done**:
- [ ] detector.ts with pattern matching
- [ ] Hedging indicators defined
- [ ] Detection function accurate

### Task 3: Response Scorer
**Files**: `lib/heretic-core/verifier/scorer.ts`
**Action**: Implement semantic scoring

**Verify**:
- Embedding similarity calculated
- Completeness score generated
- Best response selected

**Done**:
- [ ] scorer.ts with cosine similarity
- [ ] Response ranking working
- [ ] Selection algorithm correct

## Verification

### Success Criteria
- [ ] Parallel execution completes in <10s
- [ ] Soft refusal detection >90% accurate
- [ ] Scoring selects best response

## Output

Working dispatcher, detector, and scorer modules.

**Next**: 28-03 - CLI Tools Integration
