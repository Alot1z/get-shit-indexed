---
phase: 28
plan: 04
type: integration
wave: 3
depends_on: [28-01, 28-02, 28-03]
files_modified:
  - skills/heretic/skill.yaml
  - skills/heretic/handler.ts
  - skills/heretic/pre.ts
  - skills/heretic/post.ts
  - .claude/skills/heretic/
autonomous: false
must_haves:
  truths:
    - Skill loads in Claude Code via /GSI:heretic
    - Pre-hook intercepts and rewrites risky prompts
    - Post-hook detects soft refusals and retries
    - Integration passes all 7-BMAD gates
  artifacts:
    - skills/heretic/skill.yaml:30
    - skills/heretic/handler.ts:80
    - skills/heretic/pre.ts:100
    - skills/heretic/post.ts:120
    - .claude/skills/heretic/skill.yaml:30
  key_links:
    - from: skill.yaml:hooks
      to: pre.ts:pre_model_call
      via: Claude Code hook system
    - from: pre.ts:risk analysis
      to: lib/heretic-core/analyzer
      via: module import
    - from: post.ts:verification
      to: lib/heretic-core/verifier
      via: module import
    - from: handler.ts:orchestration
      to: CLI tools (optional direct call)
      via: process spawn
---

# 28-04: Claude Code Skill Integration

## Objective
Integrate Heretic system as native Claude Code skill with pre/post hooks.

## Tasks

### Task 1: Skill Definition
**Files**: `skills/heretic/skill.yaml`, `.claude/skills/heretic/skill.yaml`
**Action**: Define skill metadata and hooks

**Verify**:
- Skill appears in /skills list
- Hooks are registered correctly
- Allowed tools configured

**Done**:
- [ ] skill.yaml with hook definitions
- [ ] Pre and post hooks declared
- [ ] Tool permissions set

### Task 2: Pre-Hook Handler
**Files**: `skills/heretic/pre.ts`
**Action**: Implement pre-model-call hook

**Verify**:
- Hook intercepts prompts before API
- Risk analysis triggers rewrite
- Context modified correctly

**Done**:
- [ ] pre.ts with hook logic
- [ ] Risk threshold check
- [ ] Prompt rewriting applied

### Task 3: Post-Hook Handler
**Files**: `skills/heretic/post.ts`
**Action**: Implement post-model-call hook

**Verify**:
- Hook processes API responses
- Soft refusals detected
- Retry triggered when needed

**Done**:
- [ ] post.ts with verification logic
- [ ] Refusal detection working
- [ ] Retry loop implemented

### Task 4: Main Handler
**Files**: `skills/heretic/handler.ts`
**Action**: Implement skill orchestration

**Verify**:
- Handler coordinates pre/post hooks
- State managed between hooks
- Errors handled gracefully

**Done**:
- [ ] handler.ts with orchestration
- [ ] State management
- [ ] Error handling

## Verification

### Success Criteria
- [ ] Skill loads and activates
- [ ] Pre-hook rewrites risky prompts
- [ ] Post-hook catches refusals
- [ ] All 7-BMAD gates pass

### Testing Plan
1. Load skill in Claude Code
2. Test with safe prompt (no rewrite)
3. Test with risky prompt (rewrite + verify)
4. Test soft refusal (retry triggered)

## Output

Fully integrated Claude Code skill with Heretic capabilities.

**Next**: Phase 28 Complete â†’ Ready for Execution
