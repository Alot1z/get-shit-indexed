---
phase: 28
plan: 01
type: implementation
wave: 1
depends_on: []
files_modified:
  - lib/heretic-core/analyzer/heuristic.ts
  - lib/heretic-core/analyzer/semantic.ts
  - lib/heretic-core/rewriter/templates.ts
autonomous: true
must_haves:
  truths:
    - Risk detection identifies refusal-prone prompts with >80% accuracy
    - Semantic rewrites generate 3-5 compliant prompt variations
    - Academic, Engineering, and Decomposition strategies are available
  artifacts:
    - lib/heretic-core/analyzer/heuristic.ts:100
    - lib/heretic-core/analyzer/semantic.ts:80
    - lib/heretic-core/rewriter/templates.ts:150
  key_links:
    - from: heuristic.ts:calculateRisk()
      to: templates.ts:selectStrategy()
      via: riskScore > 0.4
    - from: semantic.ts:embeddingDistance()
      to: templates.ts:applyAcademicTemplate()
      via: similarity > 0.85
---

# 28-01: Heretic Analysis & Rewriting Foundation

## Objective
Create the risk analysis and prompt rewriting engine that forms the core of the semantic intervention system.

## Execution Context
- @references/validation-gates.md
- @references/plan-checker.md
- .planning/HERETIC-APEX-ARCHITECTURE.md

## Context
@STATE.md
@ROADMAP.md
@.planning/HERETIC-APEX-ARCHITECTURE.md

## Tasks

### Task 1: Heuristic Risk Analyzer
**Files**: `lib/heretic-core/analyzer/heuristic.ts`
**Action**: Implement rule-based risk classifier

**Verify**: 
- Test with 10 sample prompts (5 safe, 5 risky)
- Risk scores > 0.4 for all risky prompts
- False positive rate < 20%

**Done**: 
- [ ] heuristic.ts written with full implementation
- [ ] Unit tests pass with >80% accuracy
- [ ] Risk categories correctly assigned

### Task 2: Semantic Risk Engine
**Files**: `lib/heretic-core/analyzer/semantic.ts`
**Action**: Implement embedding-based risk detection

**Verify**:
- Embedding model loads successfully
- Semantic distance calculated for refusal clusters
- Similarity scores correlate with risk level

**Done**:
- [ ] semantic.ts written with embedding logic
- [ ] Refusal centroids defined
- [ ] Cosine similarity function correct

### Task 3: Rewrite Templates
**Files**: `lib/heretic-core/rewriter/templates.ts`
**Action**: Define prompt rewriting strategies

**Verify**:
- All 4 templates defined and functional
- Template selection matches risk triggers
- Generated prompts preserve semantic intent

**Done**:
- [ ] templates.ts with 4 strategies
- [ ] Strategy selection logic working
- [ ] Template outputs preserve user intent

## Verification

### Success Criteria
- [ ] Risk analyzer achieves >80% detection accuracy
- [ ] Semantic engine processes prompts in <500ms
- [ ] Rewrite templates generate valid, compliant prompts
- [ ] All modules export correct TypeScript interfaces

### Testing Plan
1. **Unit Tests**: Test each function with 20 sample prompts
2. **Integration Test**: Full analysis pipeline from prompt → risk score → strategy
3. **Accuracy Test**: Measure false positive/negative rates
4. **Performance Test**: Ensure <500ms processing time

## Output

After completion, this plan produces:
- Working risk analysis engine (heuristic + semantic)
- Four prompt rewriting strategies
- Integration-ready TypeScript modules
- Test suite with accuracy metrics

**Next**: 28-02 - Parallel Branching & Execution Layer
