# Plan 49-05: Architectural Refactor - prompt-enhancer

---
plan: 49-05
phase: 49
created: 2026-02-19
status: planned
tasks: 10
wave: 4
depends_on: [49-02, 49-03]
---

## Objective

Enhance and expand `lib/prompt-enhancer` to function as the "Central Nervous System" for Claude Code, while keeping the name as "prompt-enhancer" (NOT gsi-instruction-controller).

## Critical Naming Note

**IMPORTANT**: The module MUST remain named `prompt-enhancer`. Do NOT rename to `gsi-instruction-controller` or any other name.

## Expanded Scope

### Current Capabilities
- Risk assessment for prompts
- Mode selection (COMPREHENSIVE, STANDARD, LIGHTWEIGHT, NONE)
- Enhancement templates
- Skip rules for simple inputs

### New Capabilities
- System behavior enforcement
- Context health checks before execution
- Integration with all GSI modules
- Native tool blocking coordination
- Knowledge flow orchestration

## Tasks

### Wave 1: Core Enhancement (Tasks 1-4)

- [ ] **Task 1**: Add context health checker
  - Check .planning/STATE.md freshness
  - Verify ROADMAP.md alignment
  - Check phase completion status
  - Alert on stale context

- [ ] **Task 2**: Add module integration layer
  - Connect to `lib/pattern-learning/`
  - Connect to `lib/complexity/`
  - Connect to `lib/gsi-integration/`
  - Create unified knowledge flow

- [ ] **Task 3**: Add tool precedence coordinator
  - Coordinate with `hooks/pre-tool-use/`
  - Suggest optimal tools for operations
  - Log tool selection decisions

- [ ] **Task 4**: Add files-to-prompt integration
  - Auto-generate context before enhancement
  - Use --cxml format for Claude Code
  - Cache context for performance

### Wave 2: Behavior Enforcement (Tasks 5-7)

- [ ] **Task 5**: Create behavior rules engine
  - Define enforcement rules
  - Priority: Skills > MCP > Native
  - Block prohibited patterns

- [ ] **Task 6**: Add execution pre-check
  - Verify all required context loaded
  - Check hook registration status
  - Validate tool availability

- [ ] **Task 7**: Add post-execution capture
  - Capture operation patterns
  - Feed to pattern-learning
  - Update knowledge flow

### Wave 3: Testing & Documentation (Tasks 8-10)

- [ ] **Task 8**: Create test suite
  - Test enhancement modes
  - Test context health checks
  - Test module integration

- [ ] **Task 9**: Update documentation
  - Update PROMPT-ENHANCER.md
  - Add CNS architecture diagram
  - Document knowledge flow

- [ ] **Task 10**: Create integration examples
  - Example: How prompt-enhancer coordinates execution
  - Example: Knowledge flow between modules
  - Example: Context generation workflow

## Success Criteria

1. prompt-enhancer acts as Central Nervous System
2. All GSI modules connected via knowledge flow
3. Context health checks operational
4. Tool precedence coordinated
5. Name remains "prompt-enhancer" (not changed)

## Architecture Diagram

```
                    ┌─────────────────────┐
                    │   prompt-enhancer   │
                    │  (Central Nervous)  │
                    └──────────┬──────────┘
                               │
        ┌──────────────────────┼──────────────────────┐
        │                      │                      │
        ▼                      ▼                      ▼
┌───────────────┐    ┌─────────────────┐    ┌───────────────┐
│ pattern-      │    │ complexity/     │    │ gsi-          │
│ learning/     │◄───┤                 │───►│ integration/  │
└───────────────┘    └─────────────────┘    └───────────────┘
        │                      │                      │
        └──────────────────────┼──────────────────────┘
                               │
                    ┌──────────▼──────────┐
                    │   hooks/            │
                    │   (Enforcement)     │
                    └─────────────────────┘
```

## Allowed Tools (Full Cognitive Flow)

```yaml
# File Operations
mcp__desktop-commander__*     # All Desktop Commander tools

# Code Analysis
mcp__code-index-mcp__*        # All Code-Index tools
mcp__CodeGraphContext__*      # Relationship analysis

# Thinking Servers (Cognitive Flow)
mcp__sequential-thinking__*   # Step-by-step reasoning
mcp__tractatusthinking__*     # Logical structure analysis
mcp__debug-thinking__*        # Problem-solution mapping

# External Knowledge
mcp__deepwiki__*              # GitHub repo research
mcp__context7__*              # Library documentation

# Orchestration
Task                          # Subagent spawning
```
