# Plan 49-02: Tool Precedence Enforcement

---
plan: 49-02
phase: 49
created: 2026-02-19
status: planned
tasks: 12
wave: 2
depends_on: [49-01]
---

## Objective

Configure hooks and modules to enforce GSI tool precedence over native Claude Code tools, achieving 80-90% token savings.

## Problem Statement

Agents currently default to native tools (Read, Write, Bash, Grep, Glob) instead of optimized MCP tools or GSI internal features. This wastes tokens and bypasses GSI enhancements.

## Tool Precedence Hierarchy

```
1. Skills (BEST)         - 80-90% token savings
2. DesktopCommander MCP  - 50-70% token savings
3. Code-Index MCP        - 30-50% token savings
4. Other MCP Tools       - 30-50% token savings
5. Native Tools (LAST)   - 0% savings, baseline
```

## Tasks

### Wave 1: Hook Configuration (Tasks 1-4)

- [ ] **Task 1**: Update `hooks/pre-tool-use/bash-redirect.js`
  - Intercept native Bash calls
  - Route to DesktopCommander `start_process`
  - Log redirection for debugging

- [ ] **Task 2**: Create `hooks/pre-tool-use/native-blocker.js`
  - Block Read → Redirect to `mcp__desktop-commander__read_file`
  - Block Write → Redirect to `mcp__desktop-commander__write_file`
  - Block Grep → Redirect to `mcp__code-index-mcp__search_code_advanced`
  - Block Glob → Redirect to `mcp__code-index-mcp__find_files`

- [ ] **Task 3**: Update `hooks/pre-tool-use/prompt-enhancer.js`
  - Ensure prompt-enhancer activates for all /gsi: commands
  - Add mode selection (COMPREHENSIVE, STANDARD, LIGHTWEIGHT, NONE)
  - Integrate with files-to-prompt --cxml for context

- [ ] **Task 4**: Register hooks in Claude settings
  - Update `~/.claude/settings.json` with PreToolUse hooks
  - Test hook registration on fresh Claude Code session
  - Document hook installation process

### Wave 2: Module Updates (Tasks 5-8)

- [ ] **Task 5**: Update `lib/gsi-integration/index.js`
  - Add tool precedence checker
  - Log native tool usage violations
  - Provide MCP alternative suggestions

- [ ] **Task 6**: Update `lib/prompt-enhancer/index.js`
  - Add tool-aware enhancement
  - Include MCP tool usage in enhanced prompts
  - Generate context using files-to-prompt --cxml

- [ ] **Task 7**: Update `lib/pattern-learning/index.js`
  - Track tool usage patterns
  - Learn optimal tool selection
  - Feed patterns to prompt-enhancer

- [ ] **Task 8**: Create `lib/tool-precedence/` module
  - `checker.ts` - Verify tool precedence compliance
  - `router.ts` - Route native tools to MCP equivalents
  - `logger.ts` - Log tool usage for analysis
  - `metrics.ts` - Track token savings

### Wave 3: Enforcement Testing (Tasks 9-12)

- [ ] **Task 9**: Create test suite for hook enforcement
  - Test Read → DesktopCommander redirection
  - Test Write → DesktopCommander redirection
  - Test Grep → Code-Index redirection
  - Test Glob → Code-Index redirection

- [ ] **Task 10**: Run compliance audit
  - Scan all commands for native tool usage
  - Scan all workflows for native tool usage
  - Generate compliance report

- [ ] **Task 11**: Fix non-compliant files
  - Update commands using native tools
  - Update workflows using native tools
  - Update agents using native tools

- [ ] **Task 12**: Document tool precedence rules
  - Create TOOL-PRECEDENCE-GUIDE.md
  - Add examples for each tool category
  - Include token savings metrics

## Success Criteria

1. All hooks registered and active in Claude settings
2. Native tool usage blocked/routed to MCP equivalents
3. 80%+ reduction in native tool calls
4. Compliance report shows 95%+ MCP usage
5. Token savings documented and measured

## Allowed Tools (Full Cognitive Flow)

```yaml
# File Operations
mcp__desktop-commander__*     # All Desktop Commander tools

# Code Analysis
mcp__code-index-mcp__*        # All Code-Index tools
mcp__CodeGraphContext__*      # Relationship analysis

# Thinking Servers (Cognitive Flow)
mcp__sequential-thinking__*   # Step-by-step reasoning
mcp__tractatusthinking__*     # Logical structure analysis
mcp__debug-thinking__*        # Problem-solution mapping

# External Knowledge
mcp__deepwiki__*              # GitHub repo research
mcp__context7__*              # Library documentation

# Orchestration
Task                          # Subagent spawning
```

## Forbidden Tools

```
Read      # Blocked by hook
Write     # Blocked by hook
Grep      # Blocked by hook
Glob      # Blocked by hook
Bash      # Routed by hook
```
