# Phase 51-02: Critical Module Connections (TDD)

**Phase**: 51 - Archive 100% Completion
**Plan**: 51-02
**Type**: Execution
**Wave**: 2
**Depends on**: 51-01
**Status**: Partial (5/7 complete)
**Date**: 2026-02-20

---

## Objective

Wire orphaned lib modules into GSI system with TDD verification for each connection.

## Must-Haves

### Observable Truths
1. `gsi-knowledge-init.js` initializes knowledge hub
2. `gsi-integration/index.js` exports knowledge functions
3. `reflection/patterns.js` uses pattern-learning storage
4. `complexity/learning.js` queries patterns
5. `prompt-enhancer` uses complexity thresholds

### Artifacts
- `lib/gsi-knowledge-init.js` - min 50 lines
- `lib/gsi-integration/index.js` - contains knowledge exports
- `lib/reflection/patterns.js` - imports pattern-learning/storage
- `lib/complexity/learning.js` - imports pattern-learning

### Key Links
- knowledge-hub → gsi-integration (via require)
- pattern-learning → complexity (via queryPatterns)
- complexity → prompt-enhancer (via THRESHOLDS)

---

## Tasks

### Task 1: Wire knowledge-hub to gsi-integration ✓ DONE

**Files**: `lib/gsi-knowledge-init.js`, `lib/gsi-integration/index.js`

**Action:**
```javascript
// lib/gsi-knowledge-init.js
const { KnowledgeFlow } = require('./knowledge-hub');
function initializeKnowledgeFlow() { ... }
```

**TDD Test:**
```bash
node -e "const k = require('./lib/gsi-knowledge-init'); console.log(typeof k.initializeKnowledgeFlow)"
# Expected: "function"
```

**Verify:** Module loads without error
**Done:** 2026-02-20 (commit b2984a0)

---

### Task 2: Unify Pattern Storage ✓ DONE

**Files**: `lib/reflection/patterns.js`

**Action:**
```javascript
const { storePattern, getPatterns } = require('../pattern-learning/storage');
```

**TDD Test:**
```bash
node -e "const p = require('./lib/reflection/patterns'); console.log(typeof p.storePattern)"
# Expected: "function"
```

**Verify:** Reflection stores to pattern-learning
**Done:** 2026-02-20 (commit b2984a0)

---

### Task 3: Connect pattern-learning → complexity ✓ DONE

**Files**: `lib/complexity/learning.js`

**Action:**
```javascript
const { queryPatterns } = require('../pattern-learning');
async function adaptFromHistory() {
  const patterns = await queryPatterns({ type: 'complexity' });
}
```

**TDD Test:**
```bash
node -e "const l = require('./lib/complexity/learning'); console.log(typeof l.adaptFromHistory)"
# Expected: "function"
```

**Verify:** Complexity uses pattern predictions
**Done:** 2026-02-20 (commit d390a87)

---

### Task 4: Connect complexity → prompt-enhancer ✓ DONE

**Files**: `lib/prompt-enhancer/mode-selector.js`

**Action:**
```javascript
const { THRESHOLDS } = require('../complexity');
```

**TDD Test:**
```bash
node -e "const m = require('./lib/prompt-enhancer/mode-selector'); console.log(typeof m.selectMode)"
# Expected: "function"
```

**Verify:** Prompt enhancer uses complexity scores
**Done:** 2026-02-20 (commit b670207)

---

### Task 5: Wire prompt-enhancer/learning.js ✓ DONE

**Files**: `lib/prompt-enhancer/index.js`

**Action:**
```javascript
const { recordEnhancement, queryEnhancementPatterns } = require('./learning');
```

**TDD Test:**
```bash
node -e "const e = require('./lib/prompt-enhancer'); console.log(typeof e.analyzePrompt)"
# Expected: "function"
```

**Verify:** Enhancement history is recorded
**Done:** 2026-02-20 (commit b670207)

---

### Task 6: Connect module-registry to settings

**Files**: `commands/gsi/settings.md`, `lib/module-registry/index.js`

**Action:**
- Import module-registry in settings command
- Display module health from registry

**TDD Test:**
```bash
node -e "const r = require('./lib/module-registry'); console.log(typeof r.getModuleHealth)"
# Expected: "function"
```

**Verify:** Settings shows module health status
**Done:** ○ PENDING

---

### Task 7: Connect SDK to set-profile

**Files**: `commands/gsi/set-profile.md`, `lib/sdk/profile-manager.ts`

**Action:**
- Use lib/sdk/profile-manager for profile switching

**TDD Test:**
```bash
# Check if SDK profile manager exists
ls lib/sdk/profile-manager.ts || echo "NOT FOUND"
```

**Verify:** Profile switching uses SDK
**Done:** ○ PENDING

---

## Verification

### TDD Test Suite
```bash
# Run all module connection tests
npm test -- --grep "module connections" 2>/dev/null || \
node -e "
const tests = [
  () => require('./lib/gsi-knowledge-init'),
  () => require('./lib/complexity/learning'),
  () => require('./lib/prompt-enhancer'),
  () => require('./lib/reflection/patterns')
];
tests.forEach((t, i) => {
  try { t(); console.log('✓ Test ' + (i+1) + ' passed'); }
  catch(e) { console.log('✗ Test ' + (i+1) + ' failed:', e.message); }
});
"
```

### Success Criteria
- [x] knowledge-hub wired to gsi-integration
- [x] pattern-learning → complexity connected
- [x] complexity → prompt-enhancer connected
- [x] prompt-enhancer learning module wired
- [ ] module-registry → settings connected
- [ ] SDK → set-profile connected

---

## Output

After completion:
1. All 7 critical module connections working
2. TDD tests passing for each connection
3. Knowledge flow chains functional
4. Token savings: 80-90% verified

---

**Progress**: 5/7 tasks complete (71%)
