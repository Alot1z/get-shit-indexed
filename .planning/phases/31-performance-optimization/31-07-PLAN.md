---
phase: 31
plan: 07
title: Bundle Optimization
wave: 3
depends_on: [31-06]
files_modified:
  - vite.config.ts
  - scripts/optimize-bundle.sh
autonomous: true
must_haves:
  truths:
    - Bundle size minimized
    - Tree shaking effective
    - Chunks optimized
  artifacts:
    - vite.config.ts:100 (update)
    - scripts/optimize-bundle.sh:30
---

# 31-07: Bundle Optimization

## Objective
Optimize bundle size and loading performance.

## Tasks

### Task 1: Vite Configuration
**File**: `vite.config.ts` (update)
**Lines**: ~100

```typescript
import { defineConfig } from 'vite';
import { resolve } from 'path';

export default defineConfig({
  build: {
    target: 'node18',
    outDir: 'dist',
    lib: {
      entry: resolve(__dirname, 'src/index.ts'),
      formats: ['es', 'cjs'],
      fileName: (format) => `index.${format === 'es' ? 'mjs' : 'js'}`
    },
    rollupOptions: {
      external: [
        // Node built-ins
        'fs', 'path', 'os', 'util', 'stream',
        'child_process', 'crypto', 'events',
        // MCP servers
        /^@modelcontextprotocol/,
        // Optional dependencies
        /^@xenova/
      ],
      output: {
        // Manual chunks for better caching
        manualChunks: {
          'vendor-core': ['yaml', 'minimatch'],
          'vendor-mcp': ['./lib/mcp-bridge']
        },
        // Minimize chunk size
        chunkFileNames: 'chunks/[name]-[hash].js',
        // Compact output
        compact: true
      }
    },
    // Minification
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true,
        drop_debugger: true,
        pure_funcs: ['console.log']
      },
      format: {
        comments: false
      }
    },
    // Source maps for debugging
    sourcemap: true,
    // Report compressed size
    reportCompressedSize: true,
    // Chunk size warnings
    chunkSizeWarningLimit: 500
  },
  // Optimize deps
  optimizeDeps: {
    include: ['yaml', 'minimatch'],
    exclude: ['@xenova/transformers']
  }
});
```

### Task 2: Bundle Optimization Script
**File**: `scripts/optimize-bundle.sh`
**Lines**: ~30

```bash
#!/bin/bash
set -e

echo "Optimizing GSI bundle..."

# Build
echo "→ Building..."
npm run build

# Analyze bundle
echo "→ Analyzing bundle size..."
npx vite-bundle-visualizer

# Check size limits
SIZE=$(stat -f%z dist/index.mjs 2>/dev/null || stat -c%s dist/index.mjs)
MAX_SIZE=$((500 * 1024)) # 500KB

if [ $SIZE -gt $MAX_SIZE ]; then
  echo "⚠️  Bundle size ($SIZE bytes) exceeds limit ($MAX_SIZE bytes)"
else
  echo "✅ Bundle size OK: $SIZE bytes"
fi

# Gzip size
gzip -c dist/index.mjs > /tmp/bundle.gz
GZIP_SIZE=$(stat -f%z /tmp/bundle.gz 2>/dev/null || stat -c%s /tmp/bundle.gz)
echo "→ Gzipped size: $GZIP_SIZE bytes"
```

## Output
- Optimized Vite configuration
- Bundle analysis script
- Size limits enforced

**Next**: 31-08 - Performance Benchmarking
