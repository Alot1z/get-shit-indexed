---
phase: 31
plan: 02
title: Token Optimization
wave: 1
depends_on: [31-01]
files_modified:
  - lib/gsi-core/optimizer/token-saver.ts
  - lib/gsi-core/optimizer/context-compressor.ts
autonomous: true
must_haves:
  truths:
    - Token usage reduced
    - Context compressed intelligently
    - Quality maintained
  artifacts:
    - lib/gsi-core/optimizer/token-saver.ts:120
    - lib/gsi-core/optimizer/context-compressor.ts:150
  key_links:
    - from: token-saver.ts:optimize()
      to: context-compressor.ts
      via: import
---

# 31-02: Token Optimization

## Objective
Implement token optimization for context compression and efficiency.

## Tasks

### Task 1: Token Saver Module
**File**: `lib/gsi-core/optimizer/token-saver.ts`
**Lines**: ~120

```typescript
import { ContextCompressor } from './context-compressor.js';

export interface TokenSavings {
  original: number;
  optimized: number;
  savedPercent: number;
}

export class TokenSaver {
  private compressor: ContextCompressor;
  private savingsHistory: TokenSavings[] = [];

  constructor() {
    this.compressor = new ContextCompressor();
  }

  /**
   * Optimize content for token efficiency
   */
  optimize(content: string): { content: string; savings: TokenSavings } {
    const originalTokens = this.estimateTokens(content);
    const optimized = this.compressor.compress(content);
    const optimizedTokens = this.estimateTokens(optimized);

    const savings: TokenSavings = {
      original: originalTokens,
      optimized: optimizedTokens,
      savedPercent: ((originalTokens - optimizedTokens) / originalTokens) * 100
    };

    this.savingsHistory.push(savings);
    return { content: optimized, savings };
  }

  /**
   * Estimate token count (rough: 1 token â‰ˆ 4 chars)
   */
  private estimateTokens(text: string): number {
    return Math.ceil(text.length / 4);
  }

  /**
   * Get average savings across all operations
   */
  getAverageSavings(): number {
    if (this.savingsHistory.length === 0) return 0;
    const total = this.savingsHistory.reduce((sum, s) => sum + s.savedPercent, 0);
    return total / this.savingsHistory.length;
  }

  /**
   * Get savings report
   */
  getReport(): { operations: number; averageSavings: number; totalSaved: number } {
    const totalOriginal = this.savingsHistory.reduce((sum, s) => sum + s.original, 0);
    const totalOptimized = this.savingsHistory.reduce((sum, s) => sum + s.optimized, 0);

    return {
      operations: this.savingsHistory.length,
      averageSavings: this.getAverageSavings(),
      totalSaved: totalOriginal - totalOptimized
    };
  }
}
```

### Task 2: Context Compressor
**File**: `lib/gsi-core/optimizer/context-compressor.ts`
**Lines**: ~150

```typescript
export interface CompressionRule {
  pattern: RegExp;
  replacement: string;
  description: string;
}

export class ContextCompressor {
  private rules: CompressionRule[] = [
    // Remove excessive whitespace
    {
      pattern: /\n{3,}/g,
      replacement: '\n\n',
      description: 'Collapse multiple blank lines'
    },
    // Remove comments (preserve intent)
    {
      pattern: /\/\/.*$/gm,
      replacement: '',
      description: 'Remove single-line comments'
    },
    // Compress function declarations
    {
      pattern: /function\s+(\w+)\s*\([^)]*\)\s*:\s*(\w+)/g,
      replacement: 'fn $1(): $2',
      description: 'Compress function signatures'
    },
    // Shorten common patterns
    {
      pattern: /\b(async\s+)?function\b/g,
      replacement: 'fn',
      description: 'Shorten function keyword'
    }
  ];

  /**
   * Compress content using rules
   */
  compress(content: string): string {
    let result = content;

    for (const rule of this.rules) {
      result = result.replace(rule.pattern, rule.replacement);
    }

    // Remove trailing whitespace on lines
    result = result.replace(/[ \t]+$/gm, '');

    return result.trim();
  }

  /**
   * Add custom compression rule
   */
  addRule(rule: CompressionRule): void {
    this.rules.push(rule);
  }

  /**
   * Remove compression rule by description
   */
  removeRule(description: string): boolean {
    const index = this.rules.findIndex(r => r.description === description);
    if (index >= 0) {
      this.rules.splice(index, 1);
      return true;
    }
    return false;
  }

  /**
   * List active rules
   */
  listRules(): CompressionRule[] {
    return [...this.rules];
  }
}
```

## Output
- Token saver module
- Context compressor
- 50%+ token reduction target

**Next**: 31-03 - Parallel Processing
