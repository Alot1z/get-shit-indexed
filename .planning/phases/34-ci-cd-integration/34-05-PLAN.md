---
phase: 34
plan: 05
title: Deployment Pipeline
wave: 2
depends_on: [34-04]
files_modified:
  - .github/workflows/deploy.yml
  - scripts/deploy.sh
autonomous: false
must_haves:
  truths:
    - Deployments automated
    - Environments separated
    - Rollbacks supported
  artifacts:
    - .github/workflows/deploy.yml:80
    - scripts/deploy.sh:50
---

# 34-05: Deployment Pipeline

## Objective
Create automated deployment pipeline.

## Tasks

### Task 1: Deploy Workflow
**File**: `.github/workflows/deploy.yml`
**Lines**: ~80

```yaml
name: Deploy

on:
  push:
    branches:
      - main
      - 'release/*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: 20

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Run tests
        run: npm test

      - name: Deploy to ${{ github.event.inputs.environment || 'staging' }}
        run: |
          if [ "${{ github.event.inputs.environment }}" == "production" ]; then
            echo "Deploying to production..."
            # npm publish --tag latest
          else
            echo "Deploying to staging..."
            # npm publish --tag next
          fi

      - name: Create deployment record
        run: |
          echo "Deployment completed at $(date)" >> DEPLOYMENTS.md
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add DEPLOYMENTS.md
          git commit -m "docs: record deployment" || true
          git push

  notify:
    needs: deploy
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Notify on success
        if: success()
        uses: discord/webhook@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          message: "✅ GSI deployed to ${{ github.event.inputs.environment || 'staging' }}"

      - name: Notify on failure
        if: failure()
        uses: discord/webhook@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          message: "❌ GSI deployment failed to ${{ github.event.inputs.environment || 'staging' }}"
```

### Task 2: Deploy Script
**File**: `scripts/deploy.sh`
**Lines**: ~50

```bash
#!/bin/bash
set -e

ENV=${1:-staging}
VERSION=$(node -p "require('./package.json').version")

echo "Deploying GSI v$VERSION to $ENV..."

# Pre-deploy checks
echo "→ Running pre-deploy checks..."
npm run lint
npm run typecheck
npm test

# Build
echo "→ Building..."
npm run build

# Version check
if [ "$ENV" == "production" ]; then
  TAG="latest"
else
  TAG="next"
fi

echo "→ Publishing with tag: $TAG"
# npm publish --tag $TAG --access public

# Post-deploy
echo "→ Deployment complete!"
echo "  Version: $VERSION"
echo "  Environment: $ENV"
echo "  Tag: $TAG"
```

## Output
- Multi-environment deploy workflow
- Pre-deploy quality checks
- Deployment notifications

**Next**: 34-06 - Monitoring Integration
