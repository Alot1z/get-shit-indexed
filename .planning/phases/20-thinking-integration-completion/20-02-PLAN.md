# Phase 20-02: PreToolUse Thinking Integration

## Objective
Integrate thinking server calls into actual tool execution so thinking happens BEFORE operations, not just in planning complexity analysis.

## Problem Analysis

**Current State:**
- lib/complexity/cognitive-flow.js exists but is only called by complexity-check.js
- complexity-check.js only triggers on Task, execute-phase, execute-plan
- Regular file operations (read, write, search) have NO thinking integration
- Thinking servers are NEVER called before individual tool operations

**Root Cause:**
The thinking integration from Phase 17 is designed for plan complexity analysis, not real-time tool execution. We need to integrate thinking at the tool invocation level.

## Tasks

### Task 1: Create Thinking Mode Selector
```
<task>
Create a thinking mode selector that determines which thinking server to use based on tool type.

1. Create lib/thinking/selector.js
2. Define tool category mappings:
   - FILE_OPS: read_file, write_file, edit_block, list_directory → Sequential
   - PROCESS_OPS: start_process, interact_with_process → Sequential
   - CODE_OPS: search_code_advanced, find_files, get_symbol_body → Tractatus
   - GRAPH_OPS: query, analyze_code_relationships, find_path → Tractatus
   - DEBUG_OPS: debug_thinking → Debug
   - COMPLEX_OPS: build_deep_index, analyze_impact → Tractatus + Sequential
3. Implement getThinkingServer(toolName) function
4. Implement getThinkingPrompt(toolName, context) function
5. Add lightweight/standard/comprehensive mode selection
</task>

<files>
lib/thinking/selector.js
</files>

<acceptance>
- Tool category mappings defined
- getThinkingServer returns correct server
- getThinkingPrompt generates appropriate prompts
- Mode selection works
</acceptance>
```

### Task 2: Implement Sequential Thinking for File Operations
```
<task>
Implement sequential thinking prompts for file operations.

1. Create lib/thinking/prompts/sequential-file.js
2. Define prompts for:
   - read_file: "What do I expect to find? What patterns to look for?"
   - write_file: "What content structure? What validation needed?"
   - edit_block: "What's the change scope? Side effects?"
   - list_directory: "What am I looking for? How to filter?"
3. Implement prompt generation with context injection
4. Add response parsing for structured output
5. Test with actual file operations
</task>

<files>
lib/thinking/prompts/sequential-file.js
</files>

<acceptance>
- Prompts defined for all file operations
- Context injection works
- Response parsing functional
- Tested with real operations
</acceptance>
```

### Task 3: Implement Tractatus Thinking for Code Operations
```
<task>
Implement tractatus thinking prompts for code operations.

1. Create lib/thinking/prompts/tractatus-code.js
2. Define prompts for:
   - search_code_advanced: "What's the logical structure? Dependencies?"
   - find_files: "What file patterns? Naming conventions?"
   - get_symbol_body: "What's the symbol's role? Callers?"
   - query: "What relationships exist? Impact scope?"
3. Implement proposition-based analysis
4. Add structure decomposition
5. Test with actual code operations
</task>

<files>
lib/thinking/prompts/tractatus-code.js
</files>

<acceptance>
- Prompts defined for all code operations
- Proposition analysis works
- Structure decomposition functional
- Tested with real operations
</acceptance>
```

### Task 4: Implement Debug Thinking for Error Analysis
```
<task>
Implement debug thinking prompts for error handling and problem solving.

1. Create lib/thinking/prompts/debug-error.js
2. Define prompts for:
   - Tool failures: "What caused failure? Hypothesis?"
   - Unexpected results: "What's different? Why?"
   - Integration issues: "Where's the disconnect?"
3. Implement problem → hypothesis → test flow
4. Add knowledge graph node creation
5. Test with simulated errors
</task>

<files>
lib/thinking/prompts/debug-error.js
</files>

<acceptance>
- Prompts defined for error scenarios
- Problem-hypothesis-test flow works
- Knowledge graph integration functional
- Tested with simulated errors
</acceptance>
```

### Task 5: Create Thinking Orchestrator
```
<task>
Create the main orchestrator that calls thinking servers before tool execution.

1. Create lib/thinking/orchestrator.js
2. Import MCP thinking server tools
3. Implement thinkBeforeTool(toolName, context) function:
   - Select appropriate thinking server
   - Generate context-aware prompt
   - Call MCP thinking server
   - Parse response
   - Log thinking result
   - Return structured thinking output
4. Add timeout handling (3s default)
5. Add graceful degradation on failure
6. Export for hook integration
</task>

<files>
lib/thinking/orchestrator.js
</files>

<acceptance>
- Orchestrator created with MCP integration
- thinkBeforeTool works for all tool types
- Timeout handling prevents hangs
- Graceful degradation on errors
- Exported for hook use
</acceptance>
```

### Task 6: Integrate with PreToolUse Hook
```
<task>
Connect the thinking orchestrator to the PreToolUse hook system.

1. Update hooks/pre-tool-use/thinking-invoke.js
2. Import thinking orchestrator
3. Call thinkBeforeTool before each tool execution
4. Store thinking result in context for post-tool use
5. Add thinking summary to tool execution log
6. Handle errors gracefully (don't block tool execution)
</task>

<files>
hooks/pre-tool-use/thinking-invoke.js
</files>

<acceptance>
- Hook calls thinking orchestrator
- Thinking happens before tool execution
- Results stored in context
- Errors don't block execution
</acceptance>
```

### Task 7: Add 7-BMAD Circle Integration
```
<task>
Map thinking server outputs to 7-BMAD circles for structured cognitive flow.

1. Create lib/thinking/7bmad-mapping.js
2. Map thinking outputs to circles:
   - Method: Implementation correctness checks
   - Mad: Integration completeness checks
   - Model: Architecture alignment checks
   - Mode: Pattern consistency checks
   - Mod: Maintainability checks
   - Modd: Extensibility checks
   - Methodd: Documentation checks
3. Implement circle prompt generation
4. Add circle-specific thinking prompts
5. Test 7-BMAD flow with sample operations
</task>

<files>
lib/thinking/7bmad-mapping.js
</files>

<acceptance>
- 7-BMAD mapping created
- Circle prompts generated correctly
- 7-BMAD flow tested
- Integration documented
</acceptance>
```

### Task 8: Create Thinking Metrics System
```
<task>
Create a metrics system to track thinking server usage and effectiveness.

1. Create lib/thinking/metrics.js
2. Track:
   - Thinking server calls per session
   - Thinking duration per operation
   - Thinking effectiveness (did it help?)
   - Degraded mode frequency
3. Implement metrics collection
4. Add metrics reporting
5. Store metrics in .planning/thinking-metrics.json
</task>

<files>
lib/thinking/metrics.js
.planning/thinking-metrics.json
</files>

<acceptance>
- Metrics system created
- All metrics tracked
- Reporting functional
- Storage implemented
</acceptance>
```

## Verification

**Must Have:**
- [ ] Thinking servers called before tool operations
- [ ] Different thinking servers for different tool types
- [ ] 7-BMAD circle integration
- [ ] Graceful degradation on thinking failures
- [ ] Metrics tracking

**Nice to Have:**
- [ ] Thinking results influence tool selection
- [ ] Thinking history for learning
- [ ] Custom thinking prompts per project

## Estimated Duration
20-25 minutes (8 tasks with MCP integration)

## Dependencies
- Phase 20-01 (Hook Registration) - hooks must be registered first
- Phase 5 (Thinking Server Integration) - thinking servers available
- Phase 17 (Complexity Prediction System) - lib/complexity patterns
