# Phase 20-01: Hook Registration in Claude Settings

## Objective
Register all PreToolUse and PostToolUse hooks in Claude's actual settings system (not just hooks.json) so they are invoked during tool execution.

## Problem Analysis

**Current State:**
- `hooks/hooks.json` contains thinking configuration but is NOT a registered hook system
- `hooks/pre-tool-use/complexity-check.js` exists but isn't invoked by Claude
- Thinking servers (sequential, tractatus, debug) are never called during tool execution

**Root Cause:**
Claude Code's hook system requires hooks to be registered in `.claude/settings.json` under `hooks.preToolUse` and `hooks.postToolUse` keys. Our hooks.json is just a configuration file, not an active hook registration.

## Tasks

### Task 1: Analyze Claude Settings Hook System
```
<task>
Research how Claude Code registers and invokes hooks.

1. Read ~/.claude/settings.json structure
2. Understand preToolUse hook registration format
3. Understand postToolUse hook registration format
4. Document the hook invocation sequence
5. Identify required hook properties (path, trigger, timeout)
</task>

<files>
~/.claude/settings.json
</files>

<acceptance>
- Hook registration format documented
- Required properties identified
- Invocation sequence understood
</acceptance>
```

### Task 2: Create Hook Registration Schema
```
<task>
Create a schema for registering hooks that will invoke our thinking system.

1. Define preToolUse hook for complexity-check.js
2. Define preToolUse hook for thinking-invoke.js (new)
3. Define postToolUse hook for reflection-capture.js
4. Create JSON schema for hook configuration
5. Add validation for hook properties
</task>

<files>
hooks/schemas/hook-schema.json
</files>

<acceptance>
- Hook schema created with all required properties
- Validates against Claude settings format
- Supports our thinking integration needs
</acceptance>
```

### Task 3: Create Thinking Invoke Hook
```
<task>
Create the thinking-invoke.js hook that calls thinking servers before tool execution.

1. Create hooks/pre-tool-use/thinking-invoke.js
2. Import thinking server MCP tools
3. Implement tool categorization (file, process, code, analysis)
4. Call appropriate thinking server based on category:
   - File ops → Sequential thinking
   - Code ops → Tractatus thinking
   - Debug ops → Debug thinking
5. Add timeout handling (5s max)
6. Log thinking results for debugging
</task>

<files>
hooks/pre-tool-use/thinking-invoke.js
</files>

<acceptance>
- Hook created with MCP thinking server calls
- Tool categorization works correctly
- Timeout handling prevents hangs
- Results logged for debugging
</acceptance>
```

### Task 4: Create Reflection Capture Hook
```
<task>
Create the reflection-capture.js hook that captures learnings after tool execution.

1. Create hooks/post-tool-use/reflection-capture.js
2. Import debug-thinking MCP tool
3. Check trigger conditions (errors, significant changes, thinking-enabled)
4. Create observation nodes in debug-thinking graph
5. Connect observations to related problems/hypotheses
6. Add error handling (non-blocking)
</task>

<files>
hooks/post-tool-use/reflection-capture.js
</files>

<acceptance>
- Hook created with debug-thinking integration
- Trigger conditions properly checked
- Observation nodes created in knowledge graph
- Errors handled gracefully (non-blocking)
</acceptance>
```

### Task 5: Register Hooks in Settings
```
<task>
Register all hooks in Claude settings so they are invoked during tool execution.

1. Read current ~/.claude/settings.json
2. Add hooks.preToolUse section with:
   - complexity-check.js (for Task, execute-phase, execute-plan)
   - thinking-invoke.js (for all tools with thinking mode)
3. Add hooks.postToolUse section with:
   - reflection-capture.js (for error and significant events)
4. Preserve existing settings
5. Write updated settings.json
</task>

<files>
~/.claude/settings.json
</files>

<acceptance>
- Hooks registered in correct format
- Existing settings preserved
- Settings.json valid JSON
- Claude can parse and load hooks
</acceptance>
```

### Task 6: Test Hook Invocation
```
<task>
Verify hooks are actually being invoked during tool execution.

1. Add console.log markers to each hook
2. Execute a simple file read operation
3. Check console/logs for hook invocation
4. Execute a code search operation
5. Verify thinking was invoked before the operation
6. Document test results
</task>

<files>
.planning/phases/20-thinking-integration-completion/20-01-VERIFICATION.md
</files>

<acceptance>
- Hooks confirmed invoked during tool execution
- Thinking servers called before operations
- Reflection captured after operations
- Test results documented
</acceptance>
```

### Task 7: Document Hook System
```
<task>
Create comprehensive documentation for the hook system.

1. Document hook registration process
2. Document each hook's purpose and triggers
3. Document thinking server call patterns
4. Add troubleshooting guide
5. Add examples of extending the system
</task>

<files>
.planning/codebase/HOOK-SYSTEM.md
</files>

<acceptance>
- Complete documentation created
- All hooks documented with examples
- Troubleshooting guide included
- Extension patterns documented
</acceptance>
```

## Verification

**Must Have:**
- [ ] Hooks registered in ~/.claude/settings.json
- [ ] PreToolUse hooks invoke before tool execution
- [ ] PostToolUse hooks invoke after tool execution
- [ ] Thinking servers called during tool operations
- [ ] Reflection captured in debug-thinking graph

**Nice to Have:**
- [ ] Hook performance metrics logged
- [ ] Hook timeout configurable
- [ ] Hooks can be disabled per session

## Estimated Duration
15-20 minutes (7 tasks with MCP tool calls)

## Dependencies
- Phase 17 (Complexity Prediction System) - uses lib/complexity/ modules
- Phase 5 (Thinking Server Integration) - thinking servers available
