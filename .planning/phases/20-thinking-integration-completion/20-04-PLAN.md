# Phase 20-04: Command Thinking Integration

## Objective
Integrate thinking servers into all GSI commands so thinking happens before, during, and after command execution.

## Problem Analysis

**Current State:**
- 29 GSI commands exist in commands/gsi/
- Commands have no thinking integration
- Commands execute without cognitive enhancement
- No reflection after command completion

**Root Cause:**
Commands were updated to use MCP tools (Phase 7) but thinking integration (Phase 15, 17) was not fully implemented at the command level.

## Tasks

### Task 1: Create Command Thinking Wrapper
```
<task>
Create a wrapper function that adds thinking to any command execution.

1. Create lib/command-thinking/wrapper.js
2. Implement withThinking(commandFn, options) function:
   - Run pre-command thinking (Tractatus for structure)
   - Execute command with thinking context
   - Run post-command reflection (Debug for learning)
3. Add thinking context injection
4. Add timing and metrics
5. Export wrapper for command use
</task>

<files>
lib/command-thinking/wrapper.js
</files>

<acceptance>
- Wrapper function created
- Pre/post thinking integrated
- Context injection works
- Metrics tracked
</acceptance>
```

### Task 2: Define Command Thinking Modes
```
<task>
Define thinking modes for different command types.

1. Create lib/command-thinking/modes.js
2. Define modes by command category:
   - PLANNING: plan-phase, discuss-phase → Comprehensive (all 3 servers)
   - EXECUTION: execute-phase, execute-plan → Standard (Sequential + Debug)
   - RESEARCH: research-phase, map-codebase → Standard
   - VERIFICATION: verify-work, audit-milestone → Lightweight (Sequential only)
   - UTILITY: progress, help, settings → None (skip thinking)
3. Implement getModeForCommand(commandName) function
4. Add mode configuration in hooks.json
5. Document mode selection logic
</task>

<files>
lib/command-thinking/modes.js
</files>

<acceptance>
- Modes defined for all command types
- Mode selection function works
- Configuration integrated
- Logic documented
</acceptance>
```

### Task 3: Update Core Planning Commands
```
<task>
Update core planning commands with thinking integration.

1. Update commands/gsi/plan-phase.md:
   - Add thinking_phase section before execution
   - Use Tractatus for structure analysis
   - Use Sequential for process planning
   - Add reflection section after completion
2. Update commands/gsi/discuss-phase.md:
   - Add thinking for gray area analysis
   - Use Tractatus for logical decomposition
3. Update commands/gsi/research-phase.md:
   - Add thinking for research direction
   - Use Sequential for research steps
</task>

<files>
commands/gsi/plan-phase.md
commands/gsi/discuss-phase.md
commands/gsi/research-phase.md
</files>

<acceptance>
- Planning commands have thinking sections
- Appropriate thinking servers used
- Reflection after completion
</acceptance>
```

### Task 4: Update Core Execution Commands
```
<task>
Update core execution commands with thinking integration.

1. Update commands/gsi/execute-phase.md:
   - Add pre-execution thinking (what could go wrong?)
   - Add mid-execution checkpoints (on track?)
   - Add post-execution reflection (what worked?)
2. Update commands/gsi/execute-plan.md:
   - Add thinking before each task
   - Add reflection after each task
   - Aggregate learnings at end
3. Update commands/gsi/map-codebase.md:
   - Add thinking for agent spawn decisions
   - Use Tractatus for architecture analysis
</task>

<files>
commands/gsi/execute-phase.md
commands/gsi/execute-plan.md
commands/gsi/map-codebase.md
</files>

<acceptance>
- Execution commands have thinking checkpoints
- Mid-execution thinking works
- Task-level reflection captured
</acceptance>
```

### Task 5: Update Verification Commands
```
<task>
Update verification commands with thinking integration.

1. Update commands/gsi/verify-work.md:
   - Add thinking for verification approach
   - Use Debug for issue detection
   - Use Tractatus for verification structure
2. Update commands/gsi/audit-milestone.md:
   - Add thinking for audit criteria
   - Use Sequential for audit process
3. Update commands/gsi/complete-milestone.md:
   - Add reflection for milestone learnings
   - Store in debug-thinking graph
</task>

<files>
commands/gsi/verify-work.md
commands/gsi/audit-milestone.md
commands/gsi/complete-milestone.md
</files>

<acceptance>
- Verification commands have thinking
- Debug thinking for issues
- Milestone learnings stored
</acceptance>
```

### Task 6: Add Thinking to Command Frontmatter
```
<task>
Update command frontmatter to declare thinking requirements.

1. Add thinking_mode field to all command frontmatters:
   - thinking_mode: comprehensive | standard | lightweight | none
2. Add thinking_servers field listing required servers:
   - thinking_servers: [tractatus, sequential, debug]
3. Add thinking_phases field for multi-phase thinking:
   - thinking_phases: [pre, during, post]
4. Update install.js to validate thinking fields
5. Document frontmatter schema
</task>

<files>
commands/gsi/*.md (all 29 files)
bin/install.js
</files>

<acceptance>
- All commands have thinking frontmatter
- Fields validated by install.js
- Schema documented
</acceptance>
```

### Task 7: Create Command Thinking Metrics
```
<task>
Create metrics specific to command thinking effectiveness.

1. Create lib/command-thinking/metrics.js
2. Track per command:
   - Thinking duration
   - Thinking effectiveness score
   - Reflection capture rate
   - Pattern discovery rate
3. Implement metrics aggregation
4. Add to gsi progress command
5. Store in .planning/command-thinking-metrics.json
</task>

<files>
lib/command-thinking/metrics.js
.planning/command-thinking-metrics.json
</files>

<acceptance>
- Command thinking metrics tracked
- Aggregation works
- Integrated with progress command
- Storage implemented
</acceptance>
```

## Verification

**Must Have:**
- [ ] All commands have thinking integration
- [ ] Thinking modes defined and used
- [ ] Core planning/execution commands updated
- [ ] Command frontmatter declares thinking
- [ ] Metrics tracked

**Nice to Have:**
- [ ] Thinking effectiveness scoring
- [ ] Per-command thinking optimization
- [ ] Thinking history per command

## Estimated Duration
20-25 minutes (7 tasks with 29 command files)

## Dependencies
- Phase 20-01 (Hook Registration) - hooks must be registered
- Phase 20-02 (PreToolUse Thinking) - thinking infrastructure
- Phase 20-03 (PostToolUse Reflection) - reflection capture
- Phase 7 (Command Layer Updates) - commands exist
