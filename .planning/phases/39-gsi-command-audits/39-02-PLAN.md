# Plan 39-02: Complete /gsi:map-codebase Audit and Enhancement

## Objective
Perform comprehensive audit of /gsi:map-codebase command to ensure all logic is complete, identify missing features, and implement enhancements.

## Context
- Command location: commands/gsi/map-codebase.md
- Purpose: Map codebase structure for understanding
- Need: Verify complete implementation, add missing features

## Tasks

### Task 1: Read and Analyze Current Command
- [x] Read commands/gsi/map-codebase.md
- [x] Extract all allowed-tools
- [x] Extract thinking_phase configuration
- [x] Extract workflow steps
- [x] Document current capabilities

### Task 2: Check Tool Coverage
- [x] Verify Desktop Commander tools (file operations)
- [x] Verify Code-Index MCP tools (code analysis)
- [x] Verify CodeGraphContext tools (relationships)
- [x] Check for missing critical tools
- [x] Add missing tools to allowed-tools

### Task 3: Verify Thinking Integration
- [x] Check thinking_phase exists
- [x] Verify mode is appropriate (STANDARD or COMPREHENSIVE)
- [x] Verify tractatus server for structure analysis
- [x] Check timeout is adequate
- [x] Verify rationale covers mapping needs

### Task 4: Analyze Workflow Steps
- [x] Check for discovery phase (file structure)
- [x] Check for analysis phase (code patterns)
- [x] Check for relationship phase (dependencies)
- [x] Check for synthesis phase (documentation)
- [x] Add missing workflow phases

### Task 5: Check Mapping-Specific Features
- [x] Verify architecture detection
- [x] Check technology stack identification
- [x] Verify pattern recognition
- [x] Check dependency mapping
- [x] Add missing mapping features

### Task 6: Identify Enhancement Opportunities
- [x] Add automatic diagram generation
- [x] Add code complexity metrics
- [x] Add coverage analysis
- [x] Add test structure mapping
- [x] Add API endpoint discovery

### Task 7: Implement Enhancements
- [x] Update thinking_phase if needed
- [x] Add missing tools
- [x] Enhance workflow steps
- [x] Add new features
- [x] Update documentation

### Task 8: Create Verification
- [x] Test command execution on sample codebase
- [x] Verify thinking servers called
- [x] Verify MCP tools accessible
- [x] Check output quality
- [x] Document test results

### Task 9: Document Audit Results
- [x] Create 39-02-AUDIT-REPORT.md
- [x] Document findings
- [x] Document changes made
- [x] Document remaining gaps
- [x] Create improvement recommendations

### Task 10: Update STATE.md
- [x] Record audit completion
- [x] Document key findings
- [x] Track enhancement decisions

## Success Criteria
- [x] /gsi:map-codebase fully analyzed
- [x] All gaps identified
- [x] Enhancements implemented
- [x] Documentation updated

## Estimated Time
45 minutes

## Dependencies
- Plan 39-01 complete

## Completion Summary

**Completed:** 2026-02-18

### Changes Made

1. **commands/gsi/map-codebase.md**
   - Added 7 new MCP tools to allowed-tools:
     - `mcp__desktop-commander__read_multiple_files`
     - `mcp__desktop-commander__get_file_info`
     - `mcp__desktop-commander__start_search`
     - `mcp__CodeGraphContext__add_code_to_graph`
     - `mcp__CodeGraphContext__analyze_code_relationships`
     - `mcp__CodeGraphContext__find_code`
     - `mcp__CodeGraphContext__calculate_cyclomatic_complexity`
     - `mcp__CodeGraphContext__find_most_complex_functions`
     - `mcp__CodeGraphContext__find_dead_code`
   - Added comprehensive `thinking_phase` configuration:
     - Mode: COMPREHENSIVE
     - Servers: tractatus, sequential, debug
     - Detailed rationale and integration notes
   - Added `<advanced_features>` section for complexity and relationship analysis

2. **agents/gsi-codebase-mapper.md**
   - Replaced native tools (Read, Bash, Grep, Glob, Write) with MCP alternatives
   - Added all CodeGraphContext tools for relationship analysis
   - Enhanced thinking_aware section with tractatus and debug servers
   - Added new step `analyze_complexity` for complexity analysis
   - Updated templates with complexity metrics and dead code sections
   - Added MCP-only enforcement rules

3. **Audit Report Created**
   - Location: .planning/phases/39-gsi-command-audits/39-02-AUDIT-REPORT.md
   - Documents all findings, gaps, and recommendations
