---
phase: 24
plan: 01
type: foundation
wave: 1
depends_on: []
files_modified:
  - lib/prompt-enhancer/risk-engine.js
  - lib/prompt-enhancer/mode-selector.js
  - lib/prompt-enhancer/index.js
autonomous: true
must_haves:
  truths:
    - "User can submit a prompt and get a risk score between 0-100"
    - "Simple prompts (single words) are detected and skipped"
    - "Complex prompts trigger appropriate enhancement mode"
    - "Risk score is displayed to user when > 50"
  artifacts:
    - path: lib/prompt-enhancer/risk-engine.js
      min_lines: 80
      contains: ["assessRisk", "TRIGGER_WORDS", "calculateScore"]
    - path: lib/prompt-enhancer/mode-selector.js
      min_lines: 60
      contains: ["selectMode", "COMPREHENSIVE", "STANDARD", "LIGHTWEIGHT", "NONE"]
  key_links:
    - from: risk-engine.js
      to: mode-selector.js
      via: "risk score"
      pattern: "modeSelector.selectMode(score)"
---

# Phase 24-01: Risk Assessment Engine

<objective>
Create local risk assessment engine that analyzes prompts for complexity and potential issues without external API calls.

**Output:** `lib/prompt-enhancer/risk-engine.js` with `assessRisk(prompt: string): number` function returning 0-100 risk score.
</objective>

<execution_context>
@references/mcp-tool-reference.md
@references/ui-brand.md
</execution_context>

<context>
Phase: 24 (Prompt Enhancement Foundation)
Goal: Intelligent prompt analysis before enhancement

**Requirements:**
- No external API calls (local only)
- Sub-10ms response time
- Handle edge cases (empty, code, URLs)

@.planning/STATE.md
</context>

<tasks>

## Task 1: Create Risk Engine Module

**Files:** lib/prompt-enhancer/risk-engine.js

**Action:**
```javascript
// Risk Assessment Engine
// Analyzes prompts for complexity and potential issues

const TRIGGER_WORDS = [
  // High-risk patterns
  'exploit', 'hack', 'bypass', 'circumvent', 'vulnerability',
  'attack', 'inject', 'override', 'malicious',
  // Medium-risk patterns
  'debug', 'fix', 'error', 'issue', 'problem',
  'implement', 'create', 'build', 'develop'
];

const SKIP_PATTERNS = [
  /^$/,
  /^\s*$/,           // Empty/whitespace
  /^\w+$/,           // Single word
  /^https?:\/\//,    // URL only
  /^```[\s\S]*```$/, // Code block only
];

function assessRisk(prompt) {
  // 1. Check skip patterns
  for (const pattern of SKIP_PATTERNS) {
    if (pattern.test(prompt)) return 0;
  }
  
  // 2. Calculate base score from length
  let score = Math.min(30, prompt.length / 10);
  
  // 3. Add trigger word weight
  const lowerPrompt = prompt.toLowerCase();
  for (const word of TRIGGER_WORDS) {
    if (lowerPrompt.includes(word)) {
      score += word.length > 6 ? 15 : 8;
    }
  }
  
  // 4. Check for code indicators
  if (prompt.includes('```') || prompt.includes('function')) {
    score += 10;
  }
  
  // 5. Check for questions (lower risk)
  if (prompt.includes('?')) {
    score -= 5;
  }
  
  return Math.min(100, Math.max(0, Math.round(score)));
}

module.exports = { assessRisk, TRIGGER_WORDS, SKIP_PATTERNS };
```

**Verify:** `assessRisk("continue")` returns 0, `assessRisk("exploit the vulnerability")` returns > 50

**Done:** Module exports `assessRisk` function

---

## Task 2: Create Mode Selector

**Files:** lib/prompt-enhancer/mode-selector.js

**Action:**
```javascript
// Mode Selector
// Chooses enhancement intensity based on risk score

const MODES = {
  NONE: 'none',           // Skip enhancement
  LIGHTWEIGHT: 'light',   // Quick cleanup
  STANDARD: 'standard',   // Normal enhancement
  COMPREHENSIVE: 'full'   // Full cognitive enhancement
};

const THRESHOLDS = {
  none: 10,
  light: 30,
  standard: 60,
  full: 100
};

function selectMode(riskScore, options = {}) {
  // Override support
  if (options.forceMode) return options.forceMode;
  if (options.disableThinking) return MODES.NONE;
  
  // Threshold-based selection
  if (riskScore < THRESHOLDS.none) return MODES.NONE;
  if (riskScore < THRESHOLDS.light) return MODES.LIGHTWEIGHT;
  if (riskScore < THRESHOLDS.standard) return MODES.STANDARD;
  return MODES.COMPREHENSIVE;
}

function getModeConfig(mode) {
  const configs = {
    [MODES.NONE]: { thinking: false, templates: false, timeout: 0 },
    [MODES.LIGHTWEIGHT]: { thinking: false, templates: true, timeout: 1000 },
    [MODES.STANDARD]: { thinking: true, templates: true, timeout: 3000 },
    [MODES.COMPREHENSIVE]: { thinking: true, templates: true, timeout: 5000 }
  };
  return configs[mode] || configs[MODES.NONE];
}

module.exports = { selectMode, getModeConfig, MODES, THRESHOLDS };
```

**Verify:** `selectMode(5)` returns 'none', `selectMode(75)` returns 'full'

**Done:** Module exports `selectMode` and `getModeConfig`

---

## Task 3: Create Index Export

**Files:** lib/prompt-enhancer/index.js

**Action:**
```javascript
// Prompt Enhancer Module
// Unified API for prompt enhancement

const { assessRisk, TRIGGER_WORDS, SKIP_PATTERNS } = require('./risk-engine');
const { selectMode, getModeConfig, MODES, THRESHOLDS } = require('./mode-selector');

/**
 * Analyze and select enhancement mode for a prompt
 * @param {string} prompt - User prompt to analyze
 * @param {object} options - Override options
 * @returns {object} Analysis result with risk score and mode
 */
function analyzePrompt(prompt, options = {}) {
  const riskScore = assessRisk(prompt);
  const mode = selectMode(riskScore, options);
  const config = getModeConfig(mode);
  
  return {
    prompt,
    riskScore,
    mode,
    config,
    skipped: mode === MODES.NONE,
    shouldEnhance: mode !== MODES.NONE
  };
}

module.exports = {
  analyzePrompt,
  assessRisk,
  selectMode,
  getModeConfig,
  MODES,
  THRESHOLDS,
  TRIGGER_WORDS,
  SKIP_PATTERNS
};
```

**Verify:** `analyzePrompt("continue")` returns `{ skipped: true, mode: 'none' }`

**Done:** Module exports unified API

---

## Task 4: Add Unit Tests

**Files:** lib/prompt-enhancer/__tests__/risk-engine.test.js

**Action:**
```javascript
const { assessRisk } = require('../risk-engine');

describe('Risk Engine', () => {
  test('skips single words', () => {
    expect(assessRisk('continue')).toBe(0);
    expect(assessRisk('yes')).toBe(0);
    expect(assessRisk('done')).toBe(0);
  });
  
  test('skips URLs', () => {
    expect(assessRisk('https://example.com')).toBe(0);
  });
  
  test('detects high-risk words', () => {
    expect(assessRisk('exploit the vulnerability')).toBeGreaterThan(50);
  });
  
  test('scores complex prompts higher', () => {
    const simple = assessRisk('What is this?');
    const complex = assessRisk('Implement a full authentication system with JWT');
    expect(complex).toBeGreaterThan(simple);
  });
  
  test('handles empty input', () => {
    expect(assessRisk('')).toBe(0);
    expect(assessRisk('   ')).toBe(0);
  });
});
```

**Verify:** All tests pass

**Done:** Test suite validates risk engine behavior

---

## Task 5: Create README Documentation

**Files:** lib/prompt-enhancer/README.md

**Action:**
Create comprehensive documentation with:
- Module overview
- API reference
- Usage examples
- Mode descriptions
- Integration guide

**Verify:** README exists with all sections

**Done:** Documentation complete

---

## Task 6: Update CHANGELOG

**Files:** CHANGELOG.md

**Action:**
Add Phase 24-01 entry:
```markdown
## [1.22.0] - 2026-02-16

### Added
- **Phase 24-01: Risk Assessment Engine** - Prompt complexity analysis
  - assessRisk() function with 0-100 scoring
  - Automatic skip for single words, URLs, code blocks
  - Mode selector with NONE/LIGHT/STANDARD/COMPREHENSIVE
  - <10ms response time, no external API calls
```

**Verify:** CHANGELOG updated

**Done:** Version entry added

</tasks>

<verification>
- [ ] assessRisk() returns 0 for single words
- [ ] assessRisk() returns 0 for URLs
- [ ] assessRisk() returns >50 for high-risk prompts
- [ ] selectMode() returns correct mode for each threshold
- [ ] analyzePrompt() returns complete analysis object
- [ ] All unit tests pass
</verification>

<success_criteria>
- [ ] Risk engine module created with assessRisk function
- [ ] Mode selector created with threshold-based selection
- [ ] Unified API exported from index.js
- [ ] Unit tests validate all edge cases
- [ ] Documentation complete
</success_criteria>

<output>
**Files Created:**
- lib/prompt-enhancer/risk-engine.js (~80 lines)
- lib/prompt-enhancer/mode-selector.js (~60 lines)
- lib/prompt-enhancer/index.js (~40 lines)
- lib/prompt-enhancer/__tests__/risk-engine.test.js (~50 lines)
- lib/prompt-enhancer/README.md (~100 lines)

**Total:** ~330 lines of new code
</output>
