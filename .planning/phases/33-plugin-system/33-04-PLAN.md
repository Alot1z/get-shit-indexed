---
phase: 33
plan: 04
title: Plugin Configuration
wave: 2
depends_on: [33-03]
files_modified:
  - lib/gsi-core/plugins/plugin-config.ts
  - lib/gsi-core/plugins/config-validator.ts
autonomous: true
must_haves:
  truths:
    - Plugins configured per environment
    - Validation enforced
    - Defaults provided
  artifacts:
    - lib/gsi-core/plugins/plugin-config.ts:120
    - lib/gsi-core/plugins/config-validator.ts:80
---

# 33-04: Plugin Configuration

## Objective
Implement plugin configuration management.

## Tasks

### Task 1: Plugin Config Manager
**File**: `lib/gsi-core/plugins/plugin-config.ts`
**Lines**: ~120

```typescript
import { ConfigValidator } from './config-validator.js';

export interface PluginConfig {
  enabled: boolean;
  priority: number;
  settings: Record<string, unknown>;
}

export class PluginConfigManager {
  private configs: Map<string, PluginConfig> = new Map();
  private validator: ConfigValidator;
  private defaults: PluginConfig = {
    enabled: true,
    priority: 100,
    settings: {}
  };

  constructor() {
    this.validator = new ConfigValidator();
  }

  /**
   * Load plugin configuration
   */
  load(name: string, config: Partial<PluginConfig>): PluginConfig {
    const merged: PluginConfig = {
      enabled: config.enabled ?? this.defaults.enabled,
      priority: config.priority ?? this.defaults.priority,
      settings: { ...this.defaults.settings, ...config.settings }
    };

    // Validate
    const validation = this.validator.validate(merged);
    if (!validation.valid) {
      throw new Error(`Invalid config for ${name}: ${validation.errors.join(', ')}`);
    }

    this.configs.set(name, merged);
    return merged;
  }

  /**
   * Get plugin configuration
   */
  get(name: string): PluginConfig | undefined {
    return this.configs.get(name);
  }

  /**
   * Update plugin configuration
   */
  update(name: string, updates: Partial<PluginConfig>): PluginConfig {
    const current = this.configs.get(name);
    if (!current) {
      throw new Error(`Plugin not configured: ${name}`);
    }

    const updated: PluginConfig = {
      enabled: updates.enabled ?? current.enabled,
      priority: updates.priority ?? current.priority,
      settings: { ...current.settings, ...updates.settings }
    };

    const validation = this.validator.validate(updated);
    if (!validation.valid) {
      throw new Error(`Invalid config update: ${validation.errors.join(', ')}`);
    }

    this.configs.set(name, updated);
    return updated;
  }

  /**
   * Get all enabled plugins sorted by priority
   */
  getEnabled(): Array<{ name: string; config: PluginConfig }> {
    return Array.from(this.configs.entries())
      .filter(([, config]) => config.enabled)
      .map(([name, config]) => ({ name, config }))
      .sort((a, b) => a.config.priority - b.config.priority);
  }

  /**
   * Export configuration
   */
  export(): Record<string, PluginConfig> {
    return Object.fromEntries(this.configs);
  }
}
```

### Task 2: Config Validator
**File**: `lib/gsi-core/plugins/config-validator.ts`
**Lines**: ~80

```typescript
import type { PluginConfig } from './plugin-config.js';

export interface ConfigValidation {
  valid: boolean;
  errors: string[];
}

export class ConfigValidator {
  /**
   * Validate plugin configuration
   */
  validate(config: PluginConfig): ConfigValidation {
    const errors: string[] = [];

    // Check enabled is boolean
    if (typeof config.enabled !== 'boolean') {
      errors.push('enabled must be a boolean');
    }

    // Check priority is valid
    if (typeof config.priority !== 'number' || config.priority < 0) {
      errors.push('priority must be a non-negative number');
    }

    // Check settings is an object
    if (typeof config.settings !== 'object' || config.settings === null) {
      errors.push('settings must be an object');
    }

    return {
      valid: errors.length === 0,
      errors
    };
  }
}
```

## Output
- Plugin configuration manager
- Configuration validation
- Priority-based plugin ordering

**Next**: 33-05 - Plugin Hooks
