---
phase: 28
name: Planning Phase TDD Integration
type: integration
wave: 1
depends_on: ["28-01"]
files_modified:
  - .planning/phases/
  - templates/
  - scripts/
autonomous: true
must_haves:
  truths:
    - "All future PLAN.md files include TDD section"
    - "TDD template is referenced in all planning workflows"
    - "Planning documents include TDD test requirements"
  artifacts:
    - path: .planning/phases/28-tdd-integration/28-02-PLAN.md
      min_lines: 100
      contains: ["TDD Template", "Planning Validation", "Auto-Apply"]
  key_links:
    - from: 28-02
      to: all future phases
      via: "TDD enforcement"
      pattern: "All plans include TDD section automatically"
---

# Phase 28-02: Planning Phase TDD Integration

<objective>
Integrate TDD template and validation into all GSI planning workflows to ensure every future phase includes comprehensive TDD sections.

**Output:** TDD template integrated into all planning tools, all existing plans audited for TDD compliance.
</objective>

<execution_context>
@references/tool-priority.md
@references/ui-brand.md
</execution_context>

<context>
Phase: 28 (TDD Integration)
Depends on: 28-01 (TDD Template System)

**Planning TDD Requirements:**
- All PLAN.md must include TDD section
- All planning workflows must reference TDD template
- All templates must include TDD examples
- All commands must validate TDD compliance

@.planning/STATE.md
</context>

<tasks>

## Task 1: Create TDD Template for All Planning Templates

**Files:** templates/*.md (update all planning templates)

**Action:**
Update the following templates to include TDD section:

### templates/PLAN.md
Add after execution_context:

```markdown
## TDD Test Cases

**Objective:** Verify this phase achieves all planned outcomes through tests

### Test Categories

1. **Unit Tests** - Individual components, functions, modules
2. **Integration Tests** - Component interactions
3. **E2E Tests** - End-to-end workflow validation
4. **Boundary Tests** - Edge cases and boundary conditions

### Test-First Execution Order

For each task in this phase:
1. **Red Phase** - Write failing test first
2. **Green Phase** - Implement minimal code to pass test
3. **Refactor Phase** - Improve code quality without changing behavior
4. **Verify Phase** - Ensure test still passes

### Example Test Structure

```javascript
describe('TaskName', () => {
  test('should accomplish X', () => {
    // Arrange
    const input = 'value';
    
    // Act
    const result = function(input);
    
    // Assert
    expect(result).toBe('expected');
  });
});
```

### Test Coverage Goals

| Component | Coverage Target |
|-----------|-----------------|
| Core Functions | 100% |
| Utility Modules | 90%+ |
| API Endpoints | 100% |
| CLI Commands | 100% |
| Workflows | Core flows only |

### Validation Checklist

- [ ] All tasks have TDD tests defined before implementation
- [ ] Tests fail initially (Red phase)
- [ ] Code passes tests (Green phase)
- [ ] Refactoring doesn't break tests
- [ ] Test coverage meets goals
- [ ] Tests document expected behavior
- [ ] Tests are maintainable and clear
```

### templates/MILESTONE.md
Add TDD section similar to above, plus:

```markdown
## TDD Requirements

**Each phase in this milestone must include:**
1. TDD section with test categories and execution order
2. Test coverage goals for all components
3. Test structure examples
4. Validation checklist
```

### templates/PROJECT.md
Add:

```markdown
## TDD Integration

**GSI adopts Test-Driven Development methodology:**
- All phases follow TDD Red/Green/Refactor cycle
- Test coverage is minimum 90%+ across system
- All planning documents include TDD sections
- Execution follows test-first approach
```

### templates/ROADMAP.md
Add after Phase 27:

```markdown
**TDD Requirement:** All future phases must include comprehensive TDD section with:
- Test Categories (Unit, Integration, E2E, Boundary)
- Test-First Execution Order
- Test Structure Examples
- Test Coverage Goals
- Validation Checklist
```

**Verify:** All templates updated with TDD section

**Done:** Templates include TDD requirements

---

## Task 2: Update Planning Workflows to Enforce TDD

**Files:** workflows/plan-phase.md

**Action:**
Add TDD validation step to workflow:

```markdown
## Step 6: TDD Section Validation

**Verify TDD template compliance:**

1. Check if TDD section is present in PLAN.md
2. Validate all required subsections:
   - Test Categories
   - Test-First Execution Order
   - Test Structure
   - Test Coverage Goals
   - Validation Checklist
3. Run TDD validation script if available
4. Flag if TDD section is missing or incomplete

**Command:**
```bash
node lib/tdd/validate-planning.js --phase <phase_number>
```

**Outcome:**
- ‚úì TDD section present with all required subsections
- ‚úó TDD section missing - must add before proceeding
```

**Verify:** Planning workflow enforces TDD compliance

**Done:** Planning workflow validates TDD

---

## Task 3: Create TDD Validation Script

**Files:** scripts/validate-tdd.js (create new)

**Action:**
```javascript
/**
 * TDD Validation Script
 * Validates that planning documents include TDD sections
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

const REQUIRED_TDD_SECTIONS = [
  'TDD Test Cases',
  'Test Categories',
  'Test-First Execution Order',
  'Test Structure',
  'Test Coverage Goals',
  'Validation Checklist'
];

const REQUIRED_EXECUTION_ORDER = [
  'Red Phase',
  'Green Phase',
  'Refactor Phase'
];

/**
 * Validate TDD section in a single plan
 */
function validateSinglePlan(phaseNumber) {
  const planPath = path.join(__dirname, '../.planning/phases', 
    `phase-${phaseNumber}`, 'PLAN.md');
  
  if (!fs.existsSync(planPath)) {
    console.log(`‚ùå Phase ${phaseNumber}: PLAN.md not found`);
    return { valid: false };
  }
  
  const content = fs.readFileSync(planPath, 'utf8');
  const issues = [];
  const missing = [];
  
  // Check required sections
  REQUIRED_TDD_SECTIONS.forEach(section => {
    if (!content.includes(section)) {
      missing.push(section);
    }
  });
  
  // Check TDD execution order
  const hasOrder = REQUIRED_EXECUTION_ORDER.every(step => 
    content.includes(step)
  );
  
  if (!hasOrder) {
    issues.push('Missing TDD execution order');
  }
  
  const hasTDD = missing.length === 0;
  
  if (hasTDD) {
    console.log(`‚úì Phase ${phaseNumber}: TDD section present`);
  } else {
    console.log(`‚ùå Phase ${phaseNumber}: Missing TDD sections: ${missing.join(', ')}`);
  }
  
  return {
    phase: phaseNumber,
    valid: hasTDD,
    missing_sections: missing,
    issues,
    passed: hasTDD
  };
}

/**
 * Validate all phases in a milestone
 */
function validateMilestone(milestoneNumber) {
  const phasesDir = path.join(__dirname, '../.planning/phases');
  const phases = fs.readdirSync(phasesDir)
    .filter(f => f.startsWith(`phase-${milestoneNumber}`))
    .map(f => parseInt(f.replace('phase-', '')));
  
  console.log(`\nüìö Validating Phase ${milestoneNumber} TDD compliance...\n`);
  
  const results = phases.map(p => validateSinglePlan(p));
  
  const passed = results.filter(r => r.passed).length;
  const total = results.length;
  const percentage = Math.round((passed / total) * 100);
  
  console.log(`\nüìä TDD Compliance: ${passed}/${total} (${percentage}%)`);
  
  if (percentage === 100) {
    console.log('‚úÖ All phases TDD compliant!');
  } else {
    console.log(`‚ö†Ô∏è  ${total - passed} phase(s) need TDD sections added`);
  }
  
  return results;
}

/**
 * Auto-fix missing TDD sections
 */
function autoFixTDDSection(phaseNumber) {
  const templatePath = path.join(__dirname, '../templates/TDD-TEMPLATE.md');
  const planPath = path.join(__dirname, '../.planning/phases', 
    `phase-${phaseNumber}`, 'PLAN.md');
  
  if (!fs.existsSync(planPath)) {
    console.log('PLAN.md not found');
    return false;
  }
  
  const template = fs.readFileSync(templatePath, 'utf8');
  const content = fs.readFileSync(planPath, 'utf8');
  
  // Find insertion point (after execution_context)
  const execContextIndex = content.indexOf('## Execution Context');
  if (execContextIndex === -1) {
    console.log('Could not find execution_context section');
    return false;
  }
  
  const insertPosition = execContextIndex + 500; // Insert after context
  
  const updated = 
    content.slice(0, insertPosition) + 
    '\n\n' + template + 
    '\n\n' + 
    content.slice(insertPosition);
  
  fs.writeFileSync(planPath, updated);
  console.log(`‚úÖ Added TDD section to Phase ${phaseNumber}`);
  return true;
}

// Command line interface
const args = process.argv.slice(2);

if (args[0] === 'milestone') {
  validateMilestone(parseInt(args[1]));
} else if (args[0] === 'phase') {
  validateSinglePlan(parseInt(args[1]));
} else if (args[0] === 'auto-fix') {
  autoFixTDDSection(parseInt(args[1]));
} else {
  console.log('Usage:');
  console.log('  node validate-tdd.js milestone <number>');
  console.log('  node validate-tdd.js phase <number>');
  console.log('  node validate-tdd.js auto-fix <number>');
}
```

**Verify:** Script validates and auto-fixes TDD sections

**Done:** TDD validation script created

---

## Task 4: Add TDD Validation to Planning Commands

**Files:** commands/gsi/plan-phase.md

**Action:**
Update command to include TDD validation:

```markdown
## TDD Validation

**Before proceeding with planning, verify:**

```bash
node scripts/validate-tdd.js phase <phase_number>
```

**Required TDD Sections:**
- TDD Test Cases
- Test Categories
- Test-First Execution Order  
- Test Structure
- Test Coverage Goals
- Validation Checklist

**If validation fails:**
1. Review missing sections
2. Add TDD template from templates/TDD-TEMPLATE.md
3. Re-run validation
4. Only proceed when all checks pass
```

**Verify:** Planning command enforces TDD compliance

**Done:** Planning command updated

---

## Task 5: Create TDD Compliance Check in GSI Commands

**Files:** commands/gsi/insert-phase.md

**Action:**
Add TDD check when creating new phase:

```markdown
## TDD Compliance Check

**When creating new phase, verify TDD compliance:**

```bash
# Check if TDD section exists
grep -q "TDD Test Cases" .planning/phases/<phase_number>/PLAN.md

# If not present, add TDD template
cat templates/TDD-TEMPLATE.md >> .planning/phases/<phase_number>/PLAN.md
```

**TDD Requirements for new phases:**
1. All PLAN.md files must include TDD section
2. All templates must reference TDD template
3. Test coverage goals must be specified
4. Test structure examples must be provided

**Fail if:**
- TDD section is missing or incomplete
- No test categories defined
- No test-First execution order specified
- No test coverage goals set
```

**Verify:** Insert-phase command enforces TDD for new phases

**Done:** Insert-phase command updated
</tasks>

<verification>
- [ ] All templates updated with TDD sections
- [ ] Planning workflows validate TDD compliance
- [ ] TDD validation script created and tested
- [ ] Planning commands enforce TDD
- [ ] Insert-phase command enforces TDD for new phases
</verification>

<success_criteria>
- [ ] TDD template integrated into all templates
- [ ] Planning workflows validate TDD
- [ ] Validation script created
- [ ] All planning commands enforce TDD
</success_criteria>

<output>
**Files Created:**
- scripts/validate-tdd.js (~150 lines)

**Files Modified:**
- templates/PLAN.md (added TDD section)
- templates/MILESTONE.md (added TDD requirements)
- templates/PROJECT.md (added TDD integration)
- templates/ROADMAP.md (added TDD requirement)
- workflows/plan-phase.md (added TDD validation)
- commands/gsi/plan-phase.md (added TDD validation)
- commands/gsi/insert-phase.md (added TDD compliance check)

**Total:** ~200 lines of new code
</output>
