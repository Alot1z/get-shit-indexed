---
phase: 28
name: TDD Integration
type: infrastructure
wave: 1
depends_on: ["24"]
files_modified:
  - .planning/phases/
  - .planning/ROADMAP.md
  - .planning/STATE.md
autonomous: true
must_haves:
  truths:
    - "All GSI phases include TDD test sections"
    - "All GSI planning documents include TDD requirements"
    - "All GSI execution follows test-first approach"
    - "All phases have comprehensive test coverage"
  artifacts:
    - path: .planning/phases/28-tdd-integration/28-01-PLAN.md
      min_lines: 100
      contains: ["TDD Template", "Test-First", "Test Validation"]
  key_links:
    - from: 28-01
      to: all future phases
      via: "TDD Template"
      pattern: "All plans include TDD section"
---

# Phase 28: TDD Integration

<objective>
Make Test-Driven Development (TDD) mandatory across all GSI phases, planning, and execution. Ensure every new phase includes TDD tests, all planning documents include TDD requirements, and all execution follows test-first principles.

**Output:** TDD template system integrated into GSI, making TDD mandatory for all future phases, planning documents, and execution.
</objective>

<execution_context>
@references/tool-priority.md
@references/ui-brand.md
</execution_context>

<context>
Phase: 28 (TDD Integration)
Goal: Make TDD mandatory across entire GSI system

**TDD Integration Requirements:**
- Planning: Every PLAN.md includes TDD test cases section
- Execution: All phases follow test-first approach
- All phases: Comprehensive test coverage
- All documents: TDD requirements documented

@.planning/STATE.md
</context>

<tasks>

## Task 1: Create TDD Template for Planning Documents

**Files:** templates/TDD-TEMPLATE.md (create new)

**Action:**
```markdown
# TDD Test Cases

**Objective:** Verify this phase achieves all planned outcomes through tests

## Test Categories

### 1. Unit Tests
Tests for individual components, functions, modules

### 2. Integration Tests
Tests for component interactions

### 3. E2E Tests
End-to-end workflow validation

### 4. Boundary Tests
Edge cases and boundary conditions

## Test-First Execution Order

For EACH task in this phase:
1. Write test (Red) - Should fail initially
2. Implement code (Green) - Make test pass
3. Refactor - Improve code quality
4. Verify - Test still passes
5. Document - Update tests if behavior changes

## Test Structure

### Example Unit Test
```javascript
describe('ModuleName', () => {
  test('should do X', () => {
    // Arrange
    const input = 'test';
    
    // Act
    const result = module.function(input);
    
    // Assert
    expect(result).toBe('expected');
  });
});
```

## Test Coverage Goals

| Type | Coverage Target |
|------|-----------------|
| Unit Tests | 90%+ |
| Integration Tests | Core flows only |
| E2E Tests | Critical paths only |
| Boundary Tests | 100% of edge cases |

## Validation Checklist

- [ ] All tasks have tests defined before implementation
- [ ] Tests fail before code is written
- [ ] Tests pass after implementation
- [ ] Tests remain passing after refactoring
- [ ] No tests skipped or mocked (except appropriate cases)
- [ ] Test coverage meets goals
- [ ] Tests document expected behavior
- [ ] Tests are maintainable and clear
```

**Verify:** Template created and referenced in all future plans

**Done:** TDD template document created

---

## Task 2: Create TDD Planning Validator

**Files:** lib/tdd/validator.js (create new)

**Action:**
```javascript
/**
 * TDD Planning Validator
 * Ensures all planning documents include TDD sections
 */

const fs = require('fs');
const path = require('path');

const TDD_SECTION_REQUIRED = [
  'TDD Test Cases',
  'Test Categories',
  'Test-First Execution',
  'Test Structure',
  'Test Coverage Goals',
  'Validation Checklist'
];

const TDD_EXECUTION_REQUIRED = [
  'Red Phase (Write test)',
  'Green Phase (Implement)',
  'Refactor Phase',
  'Verify Phase'
];

/**
 * Validate a planning document includes TDD section
 * @param {string} planPath - Path to PLAN.md
 * @returns {object} Validation result
 */
function validateTDDSection(planPath) {
  const content = fs.readFileSync(planPath, 'utf8');
  const issues = [];
  const missing = [];
  
  TDD_SECTION_REQUIRED.forEach(section => {
    if (!content.includes(section)) {
      missing.push(section);
    }
  });
  
  // Check for TDD execution order
  const hasTDDOrder = TDD_EXECUTION_REQUIRED.every(step => 
    content.includes(step)
  );
  
  if (!hasTDDOrder) {
    issues.push('Missing TDD execution order (Red/Green/Refactor)');
  }
  
  return {
    valid: missing.length === 0,
    planPath,
    requiredSections: TDD_SECTION_REQUIRED,
    missingSections: missing,
    hasTDDOrder,
    issues
  };
}

/**
 * Generate TDD validation report
 * @param {string} phaseDir - Phase directory
 * @returns {object} Report
 */
function generateTDDReport(phaseDir) {
  const planPath = path.join(phaseDir, 'PLAN.md');
  
  if (!fs.existsSync(planPath)) {
    return {
      valid: false,
      error: 'PLAN.md not found in phase directory'
    };
  }
  
  const validation = validateTDDSection(planPath);
  
  return {
    phase: phaseDir,
    tdd_compliant: validation.valid,
    missing_sections: validation.missingSections,
    has_execution_order: validation.hasTDDOrder,
    issues: validation.issues,
    recommendation: validation.valid 
      ? 'PASS - TDD section present' 
      : 'FAIL - TDD section missing. Add TDD template to plan.'
  };
}

/**
 * List all phases and their TDD compliance
 * @returns {object[]} Phase TDD status
 */
function listTDDCompliance() {
  const phasesDir = path.join(__dirname, '../../.planning/phases');
  const phases = fs.readdirSync(phasesDir, { withFileTypes: true });
  
  return phases
    .filter(dirent => dirent.isDirectory())
    .filter(dirent => !dirent.name.startsWith('.'))
    .map(dirent => {
      const phaseDir = path.join(phasesDir, dirent.name);
      return {
        phase: dirent.name,
        ...generateTDDReport(phaseDir)
      };
    });
}

module.exports = {
  validateTDDSection,
  generateTDDReport,
  listTDDCompliance,
  TDD_SECTION_REQUIRED
};
```

**Verify:** validator.js creates comprehensive TDD compliance reports

**Done:** TDD validation module created

---

## Task 3: Create TDD Enforcer for Phase Execution

**Files:** lib/tdd/enforcer.js (create new)

**Action:**
```javascript
/**
 * TDD Enforcer
 * Ensures phase execution follows TDD principles
 */

const { execSync } = require('child_process');
const { existsSync } = require('fs');
const path = require('path');

/**
 * Check if phase has TDD tests defined
 * @param {string} planPath - Path to PLAN.md
 * @returns {boolean} Has TDD tests
 */
function hasTDDTests(planPath) {
  const content = require('fs').readFileSync(planPath, 'utf8');
  return content.includes('TDD Test Cases') && 
         content.includes('Test Categories');
}

/**
 * Check if tests exist for phase
 * @param {string} phaseDir - Phase directory
 * @returns {object} Test status
 */
function checkTestExistence(phaseDir) {
  const testPattern = path.join(phaseDir, '__tests__/*.test.js');
  
  try {
    execSync(`npm test -- --testPathPattern=${testPattern} --silent`);
    return {
      tests_exist: true,
      test_file_count: 0 // Would count with glob
    };
  } catch (error) {
    return {
      tests_exist: false,
      reason: 'No tests found or tests failed'
    };
  }
}

/**
 * Verify TDD execution order
 * @param {string} planPath
 * @returns {boolean} Follows TDD order
 */
function verifyTDDOrder(planPath) {
  const content = require('fs').readFileSync(planPath, 'utf8');
  const tddOrder = [
    'Red Phase',
    'Green Phase', 
    'Refactor Phase'
  ];
  
  return tddOrder.every(step => content.includes(step));
}

/**
 * Enforce TDD before execution
 * @param {string} phaseDir - Phase directory
 * @returns {object} Enforcement result
 */
async function enforceTDDBeforeExecution(phaseDir) {
  const planPath = path.join(phaseDir, 'PLAN.md');
  
  if (!existsSync(planPath)) {
    return {
      status: 'error',
      message: 'PLAN.md not found'
    };
  }
  
  const checks = {
    tdd_section: hasTDDTests(planPath),
    test_existence: checkTestExistence(phaseDir),
    tdd_order: verifyTDDOrder(planPath)
  };
  
  const all_passed = Object.values(checks).every(v => v === true);
  
  return {
    status: all_passed ? 'success' : 'blocked',
    phase: phaseDir,
    checks,
    blocked_by: !all_passed ? 
      Object.entries(checks)
        .filter(([k, v]) => !v)
        .map(([k]) => k)
    : null,
    message: all_passed ? 
      'TDD requirements satisfied - proceeding with execution' :
      'TDD requirements NOT satisfied - cannot execute'
  };
}

/**
 * Run TDD validation checklist
 * @param {string} phaseDir
 * @returns {object[]} Checklist results
 */
function runTDDChecklist(phaseDir) {
  const planPath = path.join(phaseDir, 'PLAN.md');
  const content = require('fs').readFileSync(planPath, 'utf8');
  
  return [
    {
      item: 'TDD section present',
      required: content.includes('TDD Test Cases'),
      auto_pass: true
    },
    {
      item: 'Test categories defined',
      required: content.includes('Test Categories'),
      auto_pass: true
    },
    {
      item: 'Test-First execution order',
      required: content.includes('Red Phase'),
      auto_pass: true
    },
    {
      item: 'Test structure defined',
      required: content.includes('Test Structure'),
      auto_pass: true
    },
    {
      item: 'Test coverage goals',
      required: content.includes('Test Coverage Goals'),
      auto_pass: true
    },
    {
      item: 'Validation checklist',
      required: content.includes('Validation Checklist'),
      auto_pass: true
    }
  ];
}

module.exports = {
  hasTDDTests,
  checkTestExistence,
  verifyTDDOrder,
  enforceTDDBeforeExecution,
  runTDDChecklist
};
```

**Verify:** Enforcer validates TDD before allowing execution

**Done:** TDD enforcer module created

---

## Task 4: Update ROADMAP.md with TDD Integration Section

**Files:** .planning/ROADMAP.md

**Action:**
Add after Phase 27:

```markdown
### Phase 28: TDD Integration

**Goal:** Make Test-Driven Development mandatory across all GSI phases, planning, and execution

**Depends on:** Phase 24 (Prompt Enhancement Foundation)

**Success Criteria**:
1. TDD template created and integrated into all planning documents
2. TDD validation module created for plan review
3. TDD enforcer integrated into execution workflow
4. All existing phases audited for TDD compliance
5. All new phases include comprehensive TDD sections
6. Test coverage reaches 90%+ across entire system
7. TDD Red/Green/Refactor cycle enforced for all tasks

**Plans**: 4 plans in 1 wave

**Status**: Planned ✓

**Plans**:
- [ ] 28-01: TDD Template System (5 tasks) - Wave 1
- [ ] 28-02: Planning Phase TDD Integration (5 tasks) - Wave 1
- [ ] 28-03: Execution Phase TDD Enforcement (5 tasks) - Wave 1
- [ ] 28-04: Existing Phases TDD Gap Analysis (5 tasks) - Wave 1

**TDD Integration Rules**:
1. **Planning**: Every PLAN.md must include TDD section (template provided)
2. **Execution**: All tasks must follow Red → Green → Refactor → Verify cycle
3. **Tests**: All phases must have __tests__ directory with comprehensive tests
4. **Coverage**: Minimum 90% unit test coverage, core flows tested
5. **Validation**: TDD checklist must pass before phase execution
6. **Maintenance**: Tests updated when code changes

**TDD Template Requirements**:
- Test Categories (Unit, Integration, E2E, Boundary)
- Test-First Execution Order
- Test Structure Examples
- Test Coverage Goals
- Validation Checklist
```

**Verify:** ROADMAP.md updated with Phase 28 section

**Done:** ROADMAP updated

---

## Task 5: Update STATE.md with TDD Progress

**Files:** .planning/STATE.md

**Action:**
Add new section after "Blockers/Concerns":

```markdown
### Phase 28: TDD Integration

**Goal:** Make TDD mandatory across entire GSI system

**Status:** Planned ✓

**Plans**:
- [ ] 28-01: TDD Template System (5 tasks)
- [ ] 28-02: Planning Phase TDD Integration (5 tasks)
- [ ] 28-03: Execution Phase TDD Enforcement (5 tasks)
- [ ] 28-04: Existing Phases TDD Gap Analysis (5 tasks)

**TDD Compliance Status**:
- Phase 13: Comprehensive Testing (98.8% pass rate) ✅
- Phase 24: Prompt Enhancement (50/50 tests passed) ✅
- Phase 36: Codebase Cleanup (all tests pass) ✅
- Other phases: Variable compliance ⚠️

**TDD Integration Targets**:
- 100% of future phases include TDD template
- 90%+ test coverage across entire system
- All new planning documents have TDD sections
- All execution follows Red/Green/Refactor cycle
- All agent commands test-aware
```

**Verify:** STATE.md updated with TDD tracking

**Done:** STATE.md updated
</tasks>

<verification>
- [ ] TDD template created and referenced
- [ ] Planning validator module created
- [ ] TDD enforcer module created
- [ ] ROADMAP.md updated with Phase 28
- [ ] STATE.md updated with TDD tracking
</verification>

<success_criteria>
- [ ] TDD template system integrated
- [ ] Planning documents validated for TDD
- [ ] Execution enforced to follow TDD
- [ ] All existing phases audited
- [ ] All future phases required to have TDD
</success_criteria>

<output>
**Files Created:**
- templates/TDD-TEMPLATE.md (~100 lines)
- lib/tdd/validator.js (~80 lines)
- lib/tdd/enforcer.js (~150 lines)

**Files Modified:**
- .planning/ROADMAP.md (added Phase 28)
- .planning/STATE.md (added TDD tracking)

**Total:** ~330 lines of new code
</output>
