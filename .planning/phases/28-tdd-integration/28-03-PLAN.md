---
phase: 28
name: Execution Phase TDD Enforcement
type: enforcement
wave: 1
depends_on: ["28-01", "28-02"]
files_modified:
  - lib/tdd/
  - workflows/
  - commands/
autonomous: true
must_haves:
  truths:
    - "All GSI execution follows TDD Red/Green/Refactor cycle"
    - "Test execution happens before code completion"
    - "All phases have tests that must pass"
    - "Execution is blocked if tests fail"
  artifacts:
    - path: lib/tdd/executor.js
      min_lines: 100
      contains: ["enforceTDD", "runTests", "testFirst"]
  key_links:
    - from: 28-03
      to: all workflow executions
      via: "TDD enforcement"
      pattern: "All executions must pass TDD validation"
---

# Phase 28-03: Execution Phase TDD Enforcement

<objective>
Enforce TDD principles across all GSI workflow and command executions. Ensure all execution follows test-first approach with Red/Green/Refactor cycle enforced.

**Output:** TDD enforcement integrated into all GSI workflows and commands, execution blocked if TDD requirements not met.
</objective>

<execution_context>
@references/tool-priority.md
@references/ui-brand.md
</execution_context>

<context>
Phase: 28 (TDD Integration)
Depends on: 28-01 (TDD Template), 28-02 (Planning Integration)

**Execution TDD Requirements:**
- All execution must follow test-first approach
- TDD Red/Green/Refactor cycle enforced
- Tests must pass before completion
- Execution blocked if tests fail
- All phases have comprehensive tests

@.planning/STATE.md
</context>

<tasks>

## Task 1: Create TDD Executor for Execution Enforcement

**Files:** lib/tdd/executor.js (create new)

**Action:**
```javascript
/**
 * TDD Executor
 * Enforces TDD principles during execution
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');
const { validateTDDSection, generateTDDReport } = require('./validator');

/**
 * Enforce TDD before execution
 * @param {string} phaseDir - Phase directory
 * @returns {object} Enforcement result
 */
async function enforceTDDBeforeExecution(phaseDir) {
  const planPath = path.join(phaseDir, 'PLAN.md');
  
  if (!fs.existsSync(planPath)) {
    return {
      status: 'error',
      message: 'PLAN.md not found'
    };
  }
  
  // Validate TDD section in plan
  const validation = validateTDDSection(planPath);
  
  if (!validation.valid) {
    return {
      status: 'blocked',
      message: `TDD section missing in ${path.basename(phaseDir)}`,
      missing_sections: validation.missingSections,
      recommendation: 'Add TDD template from templates/TDD-TEMPLATE.md'
    };
  }
  
  // Check if tests exist
  const testDir = path.join(phaseDir, '__tests__');
  const hasTests = fs.existsSync(testDir);
  
  // Check for test file pattern
  let testFileCount = 0;
  if (hasTests) {
    try {
      testFileCount = fs.readdirSync(testDir)
        .filter(f => f.endsWith('.test.js') || f.endsWith('.spec.js')).length;
    } catch (error) {
      // Permission error or empty directory
      testFileCount = 0;
    }
  }
  
  return {
    status: testFileCount > 0 ? 'ready' : 'warning',
    phase: path.basename(phaseDir),
    has_tdd_section: validation.valid,
    has_tests: hasTests,
    test_file_count: testFileCount,
    recommendation: testFileCount > 0 
      ? 'TDD satisfied - proceeding with execution' 
      : 'TDD section present but no tests found - consider adding tests'
  };
}

/**
 * Execute TDD Red phase (Write test)
 * @param {string} phaseDir - Phase directory
 * @returns {object} Red phase execution
 */
function executeRedPhase(phaseDir) {
  console.log('üî¥ RED PHASE: Writing tests...');
  
  // Check if tests exist
  const testDir = path.join(phaseDir, '__tests__');
  if (!fs.existsSync(testDir)) {
    return {
      phase: phaseDir,
      red_complete: false,
      message: 'Tests directory not found - cannot start Red phase'
    };
  }
  
  // List existing tests
  let testFiles = [];
  try {
    testFiles = fs.readdirSync(testDir)
      .filter(f => f.endsWith('.test.js') || f.endsWith('.spec.js'));
  } catch (error) {
    return {
      phase: phaseDir,
      red_complete: false,
      message: 'Error reading test directory'
    };
  }
  
  return {
    phase: phaseDir,
    red_complete: true,
    test_files: testFiles,
    message: `Found ${testFiles.length} test file(s)`
  };
}

/**
 * Execute TDD Green phase (Implement code)
 * @param {string} phaseDir - Phase directory
 * @returns {object} Green phase execution
 */
async function executeGreenPhase(phaseDir) {
  console.log('üü¢ GREEN PHASE: Implementing code to pass tests...');
  
  try {
    // Run tests
    execSync(`npm test -- --testPathPattern="${phaseDir}/__tests__/*"`, {
      cwd: path.join(__dirname, '../../..'),
      stdio: 'inherit'
    });
    
    return {
      phase: phaseDir,
      green_complete: true,
      test_result: 'pass',
      message: 'All tests passed successfully'
    };
  } catch (error) {
    return {
      phase: phaseDir,
      green_complete: false,
      test_result: 'fail',
      message: 'Tests failed - code needs implementation'
    };
  }
}

/**
 * Execute TDD Refactor Phase
 * @param {string} phaseDir - Phase directory
 * @returns {object} Refactor phase execution
 */
async function executeRefactorPhase(phaseDir) {
  console.log('üîµ REFACTOR PHASE: Improving code quality...');
  
  try {
    // Run tests to ensure nothing broke
    execSync(`npm test -- --testPathPattern="${phaseDir}/__tests__/*" --silent`, {
      cwd: path.join(__dirname, '../../..')
    });
    
    // Suggest refactoring improvements
    return {
      phase: phaseDir,
      refactor_complete: true,
      message: 'Tests passed - refactoring successful'
    };
  } catch (error) {
    return {
      phase: phaseDir,
      refactor_complete: false,
      message: 'Tests failed - do not refactor yet'
    };
  }
}

/**
 * Execute full TDD cycle
 * @param {string} phaseDir - Phase directory
 * @param {object} options - Options (skip_red, skip_green, skip_refactor)
 * @returns {object} Complete TDD cycle result
 */
async function executeTDDCycle(phaseDir, options = {}) {
  console.log(`\nüéØ Executing TDD Cycle for Phase: ${phaseDir}`);
  console.log('‚îÅ'.repeat(60));
  
  const results = {
    phase: phaseDir,
    red: { complete: false },
    green: { complete: false },
    refactor: { complete: false },
    timeline: []
  };
  
  // Red Phase
  if (!options.skip_red) {
    const red = executeRedPhase(phaseDir);
    results.red = red;
    results.timeline.push({ phase: 'Red', ...red });
    
    if (!red.red_complete) {
      console.log('\n‚ùå TDD Cycle Blocked: Red phase incomplete');
      return results;
    }
  }
  
  // Green Phase
  if (!options.skip_green) {
    const green = await executeGreenPhase(phaseDir);
    results.green = green;
    results.timeline.push({ phase: 'Green', ...green });
    
    if (!green.green_complete) {
      console.log('\n‚ùå TDD Cycle Blocked: Green phase incomplete - code needs implementation');
      return results;
    }
  }
  
  // Refactor Phase
  if (!options.skip_refactor) {
    const refactor = await executeRefactorPhase(phaseDir);
    results.refactor = refactor;
    results.timeline.push({ phase: 'Refactor', ...refactor });
  }
  
  // Final result
  const all_complete = results.red.complete && results.green.complete && results.refactor.complete;
  
  console.log('\n' + '‚îÅ'.repeat(60));
  if (all_complete) {
    console.log('‚úÖ TDD Cycle Complete - Phase executed successfully');
  } else {
    console.log('‚ùå TDD Cycle Incomplete - Phase execution blocked');
  }
  
  return results;
}

/**
 * Validate all tests pass before execution
 * @param {string} phaseDir - Phase directory
 * @returns {boolean} All tests pass
 */
function validateTestsBeforeExecution(phaseDir) {
  const testDir = path.join(phaseDir, '__tests__');
  
  if (!fs.existsSync(testDir)) {
    console.log(`‚ö†Ô∏è  No tests found for phase: ${phaseDir}`);
    return false;
  }
  
  try {
    execSync(`npm test -- --testPathPattern="${phaseDir}/__tests__/*" --silent`, {
      cwd: path.join(__dirname, '../../..')
    });
    return true;
  } catch (error) {
    console.log(`‚ùå Tests failed for phase: ${phaseDir}`);
    return false;
  }
}

module.exports = {
  enforceTDDBeforeExecution,
  executeRedPhase,
  executeGreenPhase,
  executeRefactorPhase,
  executeTDDCycle,
  validateTestsBeforeExecution
};
```

**Verify:** TDD executor enforces execution rules

**Done:** TDD executor created

---

## Task 2: Integrate TDD Enforcement into All Workflows

**Files:** workflows/*.md (update all workflow files)

**Action:**
Update all GSI workflows to include TDD enforcement steps:

### workflows/execute-plan.md

```markdown
## TDD Execution Flow

**Before executing plan, verify TDD compliance:**

```bash
node lib/tdd/executor.js enforce-phase <phase_number>
```

**Execution Steps:**

1. **TDD Validation** (Required)
   - Run TDD enforcement check
   - Verify test-first approach
   - Ensure tests exist and pass

2. **Red Phase** (Write tests first)
   - Write failing tests for each task
   - Document test expectations
   - Verify tests fail initially

3. **Green Phase** (Implement code)
   - Implement minimal code to pass tests
   - Run tests after each implementation
   - Ensure all tests pass

4. **Refactor Phase** (Improve code)
   - Refactor code without changing behavior
   - Run tests to verify
   - Improve test quality

5. **Verification**
   - Run full test suite
   - Verify test coverage meets goals
   - Document results

**Blocked if:**
- TDD section missing from plan
- Tests don't exist
- Tests fail
- No test-first approach followed
```

### workflows/plan-phase.md

```markdown
## TDD Integration Checklist

**Before creating plan, verify:**

- [ ] TDD template has been reviewed
- [ ] Test categories planned (Unit, Integration, E2E, Boundary)
- [ ] Test structure documented
- [ ] Test coverage goals set
- [ ] Validation checklist defined
- [ ] Red/Green/Refactor cycle specified
- [ ] Tests can be written before implementation
```

### workflows/verify-phase.md

```markdown
## TDD Verification

**During phase verification, check:**

1. **TDD Compliance**
   - ‚úì Tests written before code
   - ‚úì Tests fail initially (Red phase)
   - ‚úì Code passes tests (Green phase)
   - ‚úì Refactoring doesn't break tests

2. **Test Quality**
   - ‚úì Tests are clear and maintainable
   - ‚úì Tests document expected behavior
   - ‚úì Tests cover edge cases
   - ‚úì Tests have appropriate assertions

3. **Test Coverage**
   - ‚úì Unit test coverage >= 90%
   - ‚úì Integration tests for key flows
   - ‚úì No skipped tests
   - ‚úì No TODO comments in tests

**Blocked if:**
- Tests don't exist
- Tests are outdated
- Tests don't follow TDD order
- Test coverage below goals
```

### workflows/research-phase.md

```markdown
## TDD Research Phase

**Research should follow TDD:**

1. **Research Tests First**
   - Define what you want to verify
   - Write tests based on research findings
   - Use research to write failing tests

2. **Implement Based on Research**
   - Apply research findings
   - Make tests pass
   - Document patterns discovered

3. **Refactor Research Documentation**
   - Update tests based on refinements
   - Add more tests for edge cases
   - Improve clarity
```

**Verify:** All workflows integrate TDD enforcement

**Done:** All workflows updated with TDD steps

---

## Task 3: Update All GSI Commands to Check TDD

**Files:** commands/gsi/*.md (update all command files)

**Action:**
Add TDD checks to all GSI commands:

### commands/gsi/execute-phase.md

```markdown
## TDD Compliance Check

**Before executing a phase, verify TDD:**

```bash
node lib/tdd/executor.js enforce-phase <phase_number>
```

**Required TDD Checks:**
1. TDD section present in PLAN.md
2. Test file exists in __tests__/ directory
3. Tests pass execution
4. Test coverage goals met

**Execution blocked if:**
- TDD section missing
- No tests found
- Tests fail
- Test coverage below threshold

**If any check fails:**
1. Add missing TDD section
2. Create test files
3. Fix failing tests
4. Retry execution
```

### commands/gsi/plan-phase.md

```markdown
## TDD Planning Requirements

**When planning a new phase:**

1. Include TDD template section
2. Plan test categories (Unit, Integration, E2E, Boundary)
3. Define test structure
4. Set test coverage goals
5. Plan test-first execution order
6. Create validation checklist

**Tools:**
- TDD Template: templates/TDD-TEMPLATE.md
- Validation: node scripts/validate-tdd.js phase <number>
- Executor: node lib/tdd/executor.js enforce-phase <number>
```

### commands/gsi/verify-work.md

```markdown
## TDD Verification Steps

**Verify TDD compliance in phase:**

1. **Check TDD Section**
   - Review PLAN.md for TDD section
   - Verify all subsections present

2. **Check Tests Exist**
   - Verify __tests__/ directory
   - Count test files

3. **Run Tests**
   - Execute: npm test -- --testPathPattern=<phase>/__tests__/*
   - Verify all tests pass

4. **Check Coverage**
   - Verify test coverage >= 90%
   - Check for edge case tests

5. **Check TDD Order**
   - Verify Red phase completed
   - Verify Green phase completed
   - Verify Refactor phase completed

**Output:** TDD verification report with pass/fail status
```

**Verify:** All commands check TDD compliance

**Done:** All commands updated with TDD checks

---

## Task 4: Create TDD Progress Tracker

**Files:** .planning/tdd-progress.json (create new)

**Action:**
```json
{
  "created": "2026-02-17",
  "total_phases": 28,
  "phases_compliant": 0,
  "phases_needing_tests": 0,
  "tdd_coverage": "0%",
  "compliance_history": [],
  "gap_analysis": {
    "missing_tdd_sections": [],
    "missing_tests": [],
    "low_coverage_phases": []
  },
  "trends": {
    "weekly_additions": [],
    "failed_executions": []
  }
}
```

**Functionality:**
- Track TDD compliance across all phases
- Report coverage percentages
- Identify gaps for remediation
- Monitor trends over time

**Verify:** TDD progress tracker created

**Done:** Progress tracker created

---

## Task 5: Add TDD Metrics to GSI Status

**Files:** lib/gsi-tools.js

**Action:**
Add new command: `gsi tdd-status`

```javascript
/**
 * TDD Status Command
 * Shows TDD compliance across all phases
 */

function tddStatus() {
  const phasesDir = path.join(__dirname, '../.planning/phases');
  const phases = fs.readdirSync(phasesDir)
    .filter(f => f.startsWith('phase-') && f !== 'phase-28-tdd-integration')
    .map(f => parseInt(f.replace('phase-', '')));
  
  let compliant = 0;
  let needs_tests = 0;
  
  phases.forEach(phase => {
    const phaseDir = path.join(phasesDir, `phase-${phase}`);
    const planPath = path.join(phaseDir, 'PLAN.md');
    
    if (fs.existsSync(planPath)) {
      const content = fs.readFileSync(planPath, 'utf8');
      const hasTDD = content.includes('TDD Test Cases');
      const hasTests = fs.existsSync(path.join(phaseDir, '__tests__'));
      
      if (hasTDD) {
        if (hasTests) {
          compliant++;
        } else {
          needs_tests++;
        }
      }
    }
  });
  
  const total = phases.length;
  const coverage = Math.round((compliant / total) * 100);
  
  console.log('\nüìä TDD Compliance Report');
  console.log('‚îÅ'.repeat(60));
  console.log(`Total Phases: ${total}`);
  console.log(`‚úì Compliant: ${compliant}`);
  console.log(`‚ö†Ô∏è  Needs Tests: ${needs_tests}`);
  console.log(`Coverage: ${coverage}%`);
  console.log('‚îÅ'.repeat(60));
  
  if (coverage === 100) {
    console.log('\n‚úÖ 100% TDD compliance achieved!');
  } else if (coverage >= 50) {
    console.log(`\n‚ö†Ô∏è  ${50 - coverage}% improvement needed`);
  } else {
    console.log(`\n‚ùå Critical gap: ${100 - coverage}% improvement needed`);
  }
}

module.exports = { tddStatus };
```

**Verify:** GSI status command shows TDD metrics

**Done:** TDD metrics added to status
</tasks>

<verification>
- [ ] TDD executor created and tested
- [ ] All workflows integrate TDD enforcement
- [ ] All commands check TDD compliance
- [ ] TDD progress tracker created
- [ ] GSI status command shows TDD metrics
</verification>

<success_criteria>
- [ ] TDD executor enforces Red/Green/Refactor cycle
- [ ] All workflows require TDD validation
- [ ] All commands check TDD before execution
- [ ] Progress tracker monitors compliance
- [ ] Metrics available for status reporting
</success_criteria>

<output>
**Files Created:**
- lib/tdd/executor.js (~200 lines)
- .planning/tdd-progress.json (~50 lines)

**Files Modified:**
- workflows/execute-plan.md (added TDD flow)
- workflows/plan-phase.md (added TDD checklist)
- workflows/verify-phase.md (added TDD verification)
- workflows/research-phase.md (added TDD research phase)
- commands/gsi/execute-phase.md (added TDD check)
- commands/gsi/plan-phase.md (added TDD requirements)
- commands/gsi/verify-work.md (added TDD verification)
- lib/gsi-tools.js (added tdd-status command)

**Total:** ~350 lines of new code
</output>
