# Plan 19-01: Command Interception Layer

**Phase:** 19 (Prompt Enhancer)
**Depends on:** Phase 17 (Complexity Prediction System)
**Status:** Ready for execution

## Objective

Create the interception mechanism that captures `/gsi:` commands before execution and routes them through the enhancement pipeline.

## Architecture

```
User Input → PreToolUse Hook → ShouldEnhance? → Enhancer Pipeline → Enhanced Prompt
                                    ↓ No
                              Direct Execution
```

## Tasks

### Task 1: Create lib/prompt-enhancer directory structure
- [ ] Create `lib/prompt-enhancer/` directory
- [ ] Create `lib/prompt-enhancer/index.js` (main exports)
- [ ] Create `lib/prompt-enhancer/interceptor.js` (command interception)
- [ ] Create `lib/prompt-enhancer/enhancer.js` (cognitive enhancement)
- [ ] Create `lib/prompt-enhancer/confirmation.js` (user confirmation)

### Task 2: Implement shouldIntercept function
- [ ] Check if input starts with `/gsi:` or `/gsd:`
- [ ] Check for `--no-enhance` bypass flag
- [ ] Read `.planning/config.json` for `prompt_enhancer: true/false`
- [ ] Return boolean and interception metadata

### Task 3: Create interceptCommand function
- [ ] Extract command name (e.g., `plan-phase` from `/gsi:plan-phase 19`)
- [ ] Extract command arguments (e.g., `19`)
- [ ] Parse command structure for context

### Task 4: Implement command context extraction
- [ ] Read command definition from `commands/gsi/{command}.md`
- [ ] Extract `allowed-tools`, `description`, `argument-hint`
- [ ] Load execution context for enhancement decisions

### Task 5: Create prompt-enhancer.js PreToolUse hook
- [ ] Create `hooks/pre-tool-use/prompt-enhancer.js`
- [ ] Register trigger for inputs starting with `/gsi:` or `/gsd:`
- [ ] Integrate with existing hook system
- [ ] Add to hooks configuration

### Task 6: Implement bypass mechanism
- [ ] Support `--no-enhance` flag in command arguments
- [ ] Support config option `"prompt_enhancer": false`
- [ ] Log bypass events for analytics

### Task 7: Create index.js entry point
- [ ] Export `shouldIntercept`, `interceptCommand`, `getCommandContext`
- [ ] Export `PROMPT_ENHANCER_VERSION` constant
- [ ] Document API in comments

## Files to Create

| File | Purpose |
|------|---------|
| `lib/prompt-enhancer/index.js` | Main exports |
| `lib/prompt-enhancer/interceptor.js` | Command interception logic |
| `hooks/pre-tool-use/prompt-enhancer.js` | PreToolUse hook |

## Verification

- [ ] Commands with `/gsi:` prefix trigger interception
- [ ] `--no-enhance` flag bypasses enhancement
- [ ] Config `prompt_enhancer: false` disables system
- [ ] Command context is correctly extracted

## Integration Points

- **Phase 17:** Reuse `lib/complexity/` patterns for module structure
- **Hooks:** Integrate with existing PreToolUse hook system
- **Config:** Read from `.planning/config.json`

---

*Plan created: 2026-02-15*
