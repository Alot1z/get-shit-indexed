---
phase: 24
plan: 01
name: Universal Prompt Enhancement
type: feature
wave: 1
depends_on: []
files_modified:
  - lib/prompt-enhancer/interceptor.js
  - lib/prompt-enhancer/enhancer.js
  - lib/prompt-enhancer/confirmation.js
  - hooks/dist/gsi-pre-prompt.js
  - hooks/gsi-pre-prompt.js
autonomous: false
must_haves:
  truths:
    - "All user prompts are enhanced, not just GSI commands"
    - "Automatic mode is detected and enhancement applies without blocking"
    - "Enhanced prompts guide LLM to self-clarify through cognitive flow"
    - "User can bypass enhancement with --no-enhance flag"
  artifacts:
    - path: lib/prompt-enhancer/interceptor.js
      min_lines: 250
      contains: "shouldInterceptUniversal"
    - path: lib/prompt-enhancer/enhancer.js
      min_lines: 400
      contains: "detectAutomaticMode"
    - path: hooks/dist/gsi-pre-prompt.js
      min_lines: 100
      contains: "PreUserPrompt"
  key_links:
    - from: User input
      to: Hook
      via: PreUserPrompt event
      pattern: Hook intercepts all prompts
    - from: Hook
      to: Interceptor
      via: shouldInterceptUniversal()
      pattern: Universal detection
---

# Phase 24-01: Universal Prompt Enhancement

## Objective

Transform the Prompt Enhancer from a GSI-command-only system to a **universal prompt enhancement system** that improves ALL user prompts through cognitive enhancement, while being non-blocking for automatic workflows.

## Execution Context

@lib/prompt-enhancer/README.md (if exists)
@lib/prompt-enhancer/interceptor.js (current implementation)
@lib/prompt-enhancer/enhancer.js (current enhancement logic)

## Context

### Current State
- Prompt Enhancer only works for `/gsi:` and `/gsd:` commands
- Requires explicit GSI command prefix to trigger
- Always requires user confirmation

### Desired State
- ALL prompts are enhanced (universal)
- Automatic mode detected and non-blocking
- Enhanced prompts guide LLM to self-clarify
- Optional bypass with `--no-enhance` flag

## Tasks

### Task 1: Update Interceptor for Universal Detection
**Files:** `lib/prompt-enhancer/interceptor.js`

**Action:**
1. Rename `shouldIntercept()` to `shouldInterceptCommand()` (keep for GSI commands)
2. Add new `shouldInterceptUniversal()` function that:
   - Returns true for ALL prompts (not just GSI commands)
   - Detects automatic mode keywords: "automatic", "auto", "autonomous", "just do it", "go ahead"
   - Checks for bypass flag `--no-enhance`
   - Returns `{ shouldIntercept, isAutomatic, metadata }`

**Verify:**
```javascript
shouldInterceptUniversal("fix the bug") 
// → { shouldIntercept: true, isAutomatic: false }

shouldInterceptUniversal("automatic: implement the feature")
// → { shouldIntercept: true, isAutomatic: true }

shouldInterceptUniversal("--no-enhance just run it")
// → { shouldIntercept: false, bypassType: 'flag' }
```

**Done:** `shouldInterceptUniversal()` function exists and works for all prompt types

---

### Task 2: Add Automatic Mode Detection
**Files:** `lib/prompt-enhancer/interceptor.js`

**Action:**
Add `detectAutomaticMode(input)` function:
```javascript
/**
 * Detect if user wants automatic/autonomous execution
 * @param {string} input - User input
 * @returns {Object} - { isAutomatic: boolean, confidence: number, keywords: string[] }
 */
function detectAutomaticMode(input) {
  const automaticKeywords = [
    'automatic', 'auto', 'autonomous', 'just do it', 'go ahead',
    'do it', 'proceed', 'continue', 'yes', 'sure', 'okay',
    'no questions', "don't ask", 'skip questions', 'yolo'
  ];
  
  const lowerInput = input.toLowerCase();
  const found = automaticKeywords.filter(kw => lowerInput.includes(kw));
  
  return {
    isAutomatic: found.length > 0,
    confidence: Math.min(found.length * 0.3, 1.0),
    keywords: found
  };
}
```

**Verify:** Function correctly detects automatic mode keywords

**Done:** `detectAutomaticMode()` function exists

---

### Task 3: Update Confirmation for Non-Blocking Mode
**Files:** `lib/prompt-enhancer/confirmation.js`

**Action:**
Update `confirmEnhancement()` to skip confirmation when `isAutomatic` is true:
```javascript
async function confirmEnhancement(enhancedPrompt, originalPrompt, options = {}) {
  // If automatic mode, apply enhancement without blocking
  if (options.isAutomatic) {
    console.log(`  ${yellow}⚡${reset} Auto-enhanced prompt (automatic mode)`);
    return {
      approved: true,
      prompt: enhancedPrompt,
      autoApproved: true
    };
  }
  
  // ... existing confirmation logic
}
```

**Verify:** Automatic prompts don't trigger confirmation prompts

**Done:** Non-blocking confirmation for automatic mode

---

### Task 4: Add Self-Clarifying Prompt Structure
**Files:** `lib/prompt-enhancer/enhancer.js`

**Action:**
Update `formatEnhancedPrompt()` to add self-clarification section:
```javascript
function formatEnhancedPrompt(originalPrompt, intentResult, planResult, patternResult, score) {
  let enhanced = originalPrompt + '\n';
  
  // ... existing sections ...
  
  // Add self-clarification guidance for LLM
  if (score >= 5 && !patternResult?.isAutomatic) {
    enhanced += '\n## Self-Clarification Guidance\n';
    enhanced += 'Before proceeding, consider:\n';
    
    if (intentResult?.contextNeeded?.length > 0) {
      enhanced += `- Load context from: ${intentResult.contextNeeded.join(', ')}\n`;
    }
    
    if (planResult?.missingContext?.length > 0) {
      enhanced += `- Clarify: ${planResult.missingContext.join('; ')}\n`;
    }
    
    enhanced += '\n**If unclear**: Ask clarifying questions before implementation.\n';
    enhanced += '**If clear**: Proceed with implementation.\n';
  }
  
  return enhanced;
}
```

**Verify:** Enhanced prompts include self-clarification guidance

**Done:** Self-clarifying section added to enhanced prompts

---

### Task 5: Create Pre-User-Prompt Hook
**Files:** `hooks/gsi-pre-prompt.js`, `hooks/dist/gsi-pre-prompt.js`

**Action:**
Create a PreUserPrompt hook that intercepts ALL user input:
```javascript
#!/usr/bin/env node
/**
 * GSI Pre-Prompt Hook - Universal Prompt Enhancement
 * 
 * Intercepts ALL user prompts and enhances them through cognitive flow.
 * Triggered by: PreUserPrompt event
 */

const { shouldInterceptUniversal, detectAutomaticMode } = require('../lib/prompt-enhancer/interceptor');
const { enhancePrompt, formatEnhancedPrompt } = require('../lib/prompt-enhancer/enhancer');

async function main() {
  // Read user prompt from stdin
  let input = '';
  process.stdin.setEncoding('utf8');
  for await (const chunk of process.stdin) {
    input += chunk;
  }
  
  const promptData = JSON.parse(input);
  const userPrompt = promptData.prompt || '';
  
  // Check if should enhance
  const interceptResult = shouldInterceptUniversal(userPrompt);
  
  if (!interceptResult.shouldIntercept) {
    // No enhancement - pass through original
    console.log(JSON.stringify({ prompt: userPrompt }));
    process.exit(0);
  }
  
  // Detect automatic mode
  const autoMode = detectAutomaticMode(userPrompt);
  
  // Run enhancement
  const mcp = {}; // MCP tools would be injected
  const enhancement = await enhancePrompt(userPrompt, { name: 'universal' }, mcp);
  
  if (!enhancement.enhanced) {
    // No improvement - pass through original
    console.log(JSON.stringify({ prompt: userPrompt }));
    process.exit(0);
  }
  
  // Output enhanced prompt
  console.log(JSON.stringify({
    prompt: enhancement.enhancedPrompt,
    metadata: {
      originalPrompt: userPrompt,
      score: enhancement.score,
      isAutomatic: autoMode.isAutomatic,
      enhanced: true
    }
  }));
}

main().catch(err => {
  console.error(JSON.stringify({ error: err.message }));
  process.exit(1);
});
```

**Verify:** Hook intercepts and enhances all prompts

**Done:** Pre-user-prompt hook created

---

### Task 6: Update Hook Configuration
**Files:** `bin/install.js`

**Action:**
Add PreUserPrompt hook configuration to settings.json:
```javascript
// Configure PreUserPrompt hook for universal prompt enhancement
if (!settings.hooks) {
  settings.hooks = {};
}
if (!settings.hooks.PreUserPrompt) {
  settings.hooks.PreUserPrompt = [];
}

const hasGSIPrePromptHook = settings.hooks.PreUserPrompt.some(entry =>
  entry.hooks && entry.hooks.some(h => h.command && h.command.includes('gsi-pre-prompt'))
);

if (!hasGSIPrePromptHook) {
  settings.hooks.PreUserPrompt.push({
    hooks: [{
      type: 'command',
      command: isGlobal
        ? buildHookCommand(targetDir, 'gsi-pre-prompt.js')
        : 'node ' + dirName + '/hooks/gsi-pre-prompt.js'
    }]
  });
  console.log(`  ${green}✓${reset} Configured universal prompt enhancement hook`);
}
```

**Verify:** Hook is configured during installation

**Done:** Install script configures PreUserPrompt hook

---

## Verification

### Overall Phase Checks

- [ ] All user prompts are enhanced (not just GSI commands)
- [ ] Automatic mode detected and non-blocking
- [ ] Self-clarification guidance included in enhanced prompts
- [ ] `--no-enhance` flag bypasses enhancement
- [ ] Hook integrated into installation

### Success Criteria

- [ ] `shouldInterceptUniversal("fix the bug")` returns `{ shouldIntercept: true }`
- [ ] `detectAutomaticMode("automatic: implement it")` returns `{ isAutomatic: true }`
- [ ] Enhanced prompts include self-clarification section
- [ ] PreUserPrompt hook created and configurable
- [ ] Installation configures hook automatically

## Output

After completion:
1. Update `.planning/STATE.md` with Phase 24 progress
2. Create `24-01-SUMMARY.md` with results
3. All prompts enhanced automatically through cognitive flow

---

**Version:** 1.0
**Created:** 2026-02-16
**Status:** Ready for Execution
