---
phase: 32
plan: 05
title: Error Reporting
wave: 2
depends_on: [32-04]
files_modified:
  - lib/gsi-core/reporting/error-reporter.ts
  - lib/gsi-core/reporting/error-formatter.ts
autonomous: true
must_haves:
  truths:
    - Errors captured consistently
    - Reports formatted clearly
    - Context preserved
  artifacts:
    - lib/gsi-core/reporting/error-reporter.ts:120
    - lib/gsi-core/reporting/error-formatter.ts:80
---

# 32-05: Error Reporting

## Objective
Implement comprehensive error reporting system.

## Tasks

### Task 1: Error Reporter
**File**: `lib/gsi-core/reporting/error-reporter.ts`
**Lines**: ~120

```typescript
import { ErrorFormatter, FormattedError } from './error-formatter.js';

export interface ErrorContext {
  operation: string;
  timestamp: Date;
  metadata: Record<string, unknown>;
  stack?: string;
}

export interface ErrorReport {
  id: string;
  error: Error;
  context: ErrorContext;
  formatted: FormattedError;
}

export class ErrorReporter {
  private formatter: ErrorFormatter;
  private reports: ErrorReport[] = [];
  private maxReports: number = 100;
  private handlers: Array<(report: ErrorReport) => void> = [];

  constructor() {
    this.formatter = new ErrorFormatter();
  }

  /**
   * Report an error
   */
  report(error: Error, context: Partial<ErrorContext> = {}): ErrorReport {
    const fullContext: ErrorContext = {
      operation: context.operation ?? 'unknown',
      timestamp: context.timestamp ?? new Date(),
      metadata: context.metadata ?? {},
      stack: error.stack
    };

    const report: ErrorReport = {
      id: this.generateId(),
      error,
      context: fullContext,
      formatted: this.formatter.format(error, fullContext)
    };

    // Store report
    this.reports.push(report);
    if (this.reports.length > this.maxReports) {
      this.reports.shift();
    }

    // Notify handlers
    for (const handler of this.handlers) {
      try {
        handler(report);
      } catch {
        // Ignore handler errors
      }
    }

    return report;
  }

  /**
   * Add error handler
   */
  onReport(handler: (report: ErrorReport) => void): void {
    this.handlers.push(handler);
  }

  /**
   * Get all reports
   */
  getReports(): ErrorReport[] {
    return [...this.reports];
  }

  /**
   * Get reports by operation
   */
  getReportsByOperation(operation: string): ErrorReport[] {
    return this.reports.filter(r => r.context.operation === operation);
  }

  /**
   * Clear reports
   */
  clear(): void {
    this.reports = [];
  }

  /**
   * Export reports as JSON
   */
  export(): string {
    return JSON.stringify(this.reports.map(r => ({
      id: r.id,
      error: {
        name: r.error.name,
        message: r.error.message
      },
      context: r.context,
      formatted: r.formatted
    })), null, 2);
  }

  private generateId(): string {
    return `err_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  }
}
```

### Task 2: Error Formatter
**File**: `lib/gsi-core/reporting/error-formatter.ts`
**Lines**: ~80

```typescript
import type { ErrorContext } from './error-reporter.js';

export interface FormattedError {
  title: string;
  message: string;
  suggestions: string[];
  severity: 'low' | 'medium' | 'high' | 'critical';
  category: string;
}

export class ErrorFormatter {
  private patterns: Array<{
    match: (error: Error) => boolean;
    format: (error: Error, context: ErrorContext) => FormattedError;
  }> = [
    {
      match: (e) => e.message.includes('ENOENT'),
      format: (e, ctx) => ({
        title: 'File Not Found',
        message: `Could not find file in ${ctx.operation}`,
        suggestions: ['Check file path exists', 'Verify file permissions'],
        severity: 'medium',
        category: 'filesystem'
      })
    },
    {
      match: (e) => e.message.includes('ECONNREFUSED'),
      format: (e, ctx) => ({
        title: 'Connection Refused',
        message: 'Could not connect to MCP server',
        suggestions: ['Check MCP server is running', 'Verify server configuration'],
        severity: 'high',
        category: 'network'
      })
    },
    {
      match: (e) => e.message.includes('timeout'),
      format: (e, ctx) => ({
        title: 'Operation Timeout',
        message: `${ctx.operation} took too long`,
        suggestions: ['Try again', 'Check system resources', 'Increase timeout'],
        severity: 'medium',
        category: 'timeout'
      })
    }
  ];

  /**
   * Format an error
   */
  format(error: Error, context: ErrorContext): FormattedError {
    for (const pattern of this.patterns) {
      if (pattern.match(error)) {
        return pattern.format(error, context);
      }
    }

    // Default format
    return {
      title: error.name,
      message: error.message,
      suggestions: ['Check the error message', 'Try again'],
      severity: 'medium',
      category: 'unknown'
    };
  }
}
```

## Output
- Error reporter with context capture
- Pattern-based error formatting
- Report export capability

**Next**: 32-06 - Recovery Automation
